<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>OMI PWT Inspection</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ===============================================
   THEME VARIABLES - DARK (Default) and LIGHT
   =============================================== */
:root {
  /* Dark Theme Variables (Default) */
  --omi-red: #d32f2f;
  --omi-red-dark: #b71c1c;
  --omi-dark-1: #1a1a1a;
  --omi-dark-2: #2a2a2a;
  --omi-dark-3: #37474f;
  --omi-text-light: #f5f5f5;
  --omi-text-dark: #b0bec5;
  --omi-green: #2e7d32;
  --omi-green-dark: #1b5e20;
  
  /* Light Theme Variables */
  --light-primary: #d32f2f;
  --light-primary-dark: #b71c1c;
  --light-bg-1: #ffffff;
  --light-bg-2: #f8f9fa;
  --light-bg-3: #e9ecef;
  --light-text-dark: #212529;
  --light-text-light: #495057;
  --light-green: #2e7d32;
  --light-green-dark: #1b5e20;
  
  /* Common Variables */
  --primary: var(--omi-red);
  --primary-dark: var(--omi-red-dark);
  --secondary: var(--omi-green);
  --secondary-dark: var(--omi-green-dark);
  --light: var(--omi-dark-2);
  --light-alt: var(--omi-dark-1);
  --dark: var(--omi-text-light);
  --dark-alt: var(--omi-text-dark);
  --border: #404040;
  --border-light: #333333;
  --shadow: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-hover: 0 5px 15px rgba(0,0,0,0.4);
  --radius: 8px;
  --radius-sm: 4px;
  --transition: all 0.3s ease;
}

/* Light Theme */
body.light-theme {
  --primary: var(--light-primary);
  --primary-dark: var(--light-primary-dark);
  --secondary: var(--light-green);
  --secondary-dark: var(--light-green-dark);
  --light: var(--light-bg-2);
  --light-alt: var(--light-bg-1);
  --dark: var(--light-text-dark);
  --dark-alt: var(--light-text-light);
  --border: #dee2e6;
  --border-light: #e9ecef;
  --shadow: 0 2px 8px rgba(0,0,0,0.1);
  --shadow-hover: 0 5px 15px rgba(0,0,0,0.15);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

body {
  background: var(--omi-dark-1);
  color: var(--dark);
  line-height: 1.6;
  min-height: 100vh;
  transition: var(--transition);
}

body.light-theme {
  background: var(--light-bg-1);
}

.container {
  width: 100%;
  margin: 0 auto;
  background: var(--omi-dark-1);
}

body.light-theme .container {
  background: var(--light-bg-1);
}

.logo-header {
  background: var(--omi-dark-2);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
}

body.light-theme .logo-header {
  background: var(--light-bg-2);
}

.logo-header img {
  height: 35px;
  object-fit: contain;
}

.theme-selector {
  display: flex;
  gap: 8px;
}

.theme-btn {
  background: var(--omi-dark-3);
  border: 1px solid var(--border);
  color: var(--dark);
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 12px;
  transition: var(--transition);
}

body.light-theme .theme-btn {
  background: var(--light-bg-3);
  color: var(--light-text-dark);
}

.theme-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.header {
  background: var(--omi-dark-1);
  color: white;
  padding: 20px 16px;
  text-align: center;
  position: relative;
}

body.light-theme .header {
  background: var(--light-bg-1);
  color: var(--light-text-dark);
}

.header h1 {
  font-size: 20px;
  margin: 0;
  font-weight: 600;
  color: var(--primary);
}

.header .subtitle {
  font-size: 14px;
  opacity: 0.9;
  margin-top: 4px;
  color: var(--dark-alt);
}

.progress-container {
  padding: 16px;
  background: var(--omi-dark-2);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}

body.light-theme .progress-container {
  background: var(--light-bg-2);
}

.progress-bar {
  height: 8px;
  background: var(--border-light);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

body.light-theme .progress-bar {
  background: #e9ecef;
}

.progress-fill {
  height: 100%;
  background: var(--primary);
  width: 0%;
  transition: width 0.5s ease;
  border-radius: 4px;
}

.progress-text {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: var(--dark-alt);
}

.step-container {
  padding: 16px;
}

.step {
  display: none;
  animation: fadeIn 0.5s ease;
}

.step.active {
  display: block;
}

.section {
  background: var(--light);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin: 16px 0;
  padding: 0;
  box-shadow: var(--shadow);
  transition: var(--transition);
  border-left: 4px solid var(--border);
  overflow: hidden;
}

body.light-theme .section {
  background: var(--light-bg-2);
}

.section.completed {
  border-left: 4px solid var(--secondary);
}

.section.completed .section-title {
  color: var(--secondary);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.section.expanded .section-header {
  border-bottom: 1px solid var(--border-light);
}

.section:not(.expanded) .section-header {
  border-bottom: none;
}

.section-title {
  font-weight: 600;
  color: var(--primary);
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title i {
  font-size: 16px;
}

.section-content {
  display: none;
  padding: 16px;
  border-top: 1px solid var(--border-light);
}

.section.expanded .section-content {
  display: block;
}

.section-status {
  font-size: 14px;
  font-weight: bold;
  color: var(--dark-alt);
  margin-left: auto;
  margin-right: 16px;
}

.form-row {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.form-group {
  flex: 1 1 100%;
  padding: 10px 0;
}

.checklist-item {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.checklist-item:last-child {
  border-bottom: none;
}

label {
  display: block;
  margin: 8px 0 6px;
  font-weight: 600;
  font-size: 15px;
  color: var(--dark);
}

.required::after {
  content: " *";
  color: var(--primary);
}

input[type="text"], input[type="date"], input[type="time"], select, textarea {
  width: 100%;
  padding: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 16px;
  background: var(--omi-dark-3);
  color: var(--dark);
  transition: var(--transition);
}

body.light-theme input[type="text"],
body.light-theme input[type="date"],
body.light-theme input[type="time"],
body.light-theme select,
body.light-theme textarea {
  background: var(--light-bg-1);
  color: var(--light-text-dark);
  border-color: #ced4da;
}

input[type="file"] {
  padding: 10px;
  background: var(--omi-dark-3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  width: 100%;
}

body.light-theme input[type="file"] {
  background: var(--light-bg-1);
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.2);
}

.radio-group {
  display: flex;
  gap: 8px;
  margin: 10px 0;
  flex-wrap: nowrap;
  justify-content: space-between;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  background: var(--omi-dark-3);
  color: var(--dark-alt);
  transition: var(--transition);
  flex: 1;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
}

body.light-theme .radio-option {
  background: var(--light-bg-3);
  color: var(--light-text-light);
}

.radio-option:hover {
  background: var(--omi-dark-2);
}

body.light-theme .radio-option:hover {
  background: #e9ecef;
}

.radio-option.selected {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.radio-option.selected-ok {
  background: var(--secondary);
  color: white;
  border-color: var(--secondary);
}

.radio-option.selected-na {
  background: var(--dark-alt);
  color: var(--omi-dark-1);
  border-color: var(--dark-alt);
}

body.light-theme .radio-option.selected-na {
  color: var(--light-bg-1);
}

.radio-input { display: none; }
.status-indicator { display: none; }

.conditional-block {
  display: none;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px dashed var(--border);
  animation: fadeIn 0.3s ease;
}

.conditional-block.show {
  display: block;
}

.photo-upload {
  margin: 16px 0;
}

.photo-preview-container {
  position: relative;
  margin-top: 8px;
  display: none;
}

.photo-preview {
  max-width: 100%;
  max-height: 200px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

.remove-photo-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: rgba(0,0,0,0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 14px;
  line-height: 24px;
  text-align: center;
}

.photo-preview-container.show {
  display: block;
}

.btn {
  background: var(--primary);
  color: white;
  border: none;
  padding: 16px 24px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
}

.btn:hover {
  background: var(--primary-dark);
  transform: none;
  box-shadow: none;
}

.btn:active {
  transform: translateY(1px);
}

.btn:disabled {
  background: #555;
  color: #999;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

body.light-theme .btn:disabled {
  background: #adb5bd;
}

.btn-secondary {
  background: var(--secondary);
}

.btn-secondary:hover {
  background: var(--secondary-dark);
}

.btn-outline {
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
}

.btn-outline:hover {
  background: var(--primary);
  color: white;
}

.btn-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 12px 0;
}

.btn-group-horizontal .btn {
  flex: 1;
}

.hidden {
  display: none !important;
}

.report-section {
  background: var(--light);
  padding: 16px;
  border-radius: var(--radius);
  margin: 20px 0;
  box-shadow: var(--shadow);
}

body.light-theme .report-section {
  background: var(--light-bg-2);
}

.report-section h2 {
  color: var(--primary);
  border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}

.report-item {
  padding: 12px;
  margin: 12px 0;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--omi-dark-3);
}

body.light-theme .report-item {
  background: var(--light-bg-3);
}

.report-category {
  font-weight: 600;
  color: var(--primary);
  margin: 16px 0 12px;
  padding: 12px;
  background: rgba(211, 47, 47, 0.1);
  border-radius: var(--radius-sm);
  border-left: 4px solid var(--primary);
}

body.light-theme .report-category {
  background: rgba(211, 47, 47, 0.05);
}

.comment-box {
  margin-top: 12px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--omi-dark-2);
  color: var(--omi-text-light);
}

body.light-theme .comment-box {
  background: var(--light-bg-3);
  color: var(--light-text-dark);
}

.comment-box strong {
  color: var(--omi-red);
}

.info-card {
  background: var(--omi-dark-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin: 16px 0;
}

body.light-theme .info-card {
  background: var(--light-bg-2);
}

.info-card i {
  color: var(--primary);
  margin-right: 8px;
}

.info-card .issue-counter {
  color: var(--primary);
  font-weight: bold;
  float: right;
}

.error-message {
  color: var(--primary);
  font-size: 14px;
  margin-top: 6px;
  display: none;
}

.history-item {
  padding: 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin: 12px 0;
  background: var(--omi-dark-3);
  cursor: pointer;
  transition: var(--transition);
}

body.light-theme .history-item {
  background: var(--light-bg-3);
}

.history-item:hover {
  box-shadow: var(--shadow);
  border-color: var(--primary);
}

.history-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.history-date {
  font-weight: 600;
  color: var(--primary);
}

.history-equipment {
  font-weight: 600;
}

.history-details {
  color: var(--dark-alt);
  font-size: 14px;
}

body.light-theme .history-details {
  color: var(--light-text-light);
}

.step-indicator {
  display: flex;
  justify-content: space-between;
  margin: 16px;
  position: relative;
}

.step-indicator::before {
  content: '';
  position: absolute;
  top: 19px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--border);
  z-index: 1;
}

body.light-theme .step-indicator::before {
  background: #e9ecef;
}

.step-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  z-index: 2;
  flex: 1;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--omi-dark-2);
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  margin-bottom: 8px;
  transition: var(--transition);
  color: var(--dark-alt);
}

body.light-theme .step-number {
  background: var(--light-bg-2);
  color: var(--light-text-light);
}

.step-item.active .step-number {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}

.step-item.completed .step-number {
  background: var(--secondary);
  border-color: var(--secondary);
  color: white;
}

.step-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--dark-alt);
  text-align: center;
}

body.light-theme .step-label {
  color: var(--light-text-light);
}

.step-item.active .step-label {
  color: var(--primary);
  font-weight: 600;
}

.step-item.completed .step-label {
  color: var(--secondary);
}

.photo-counter {
  font-size: 12px;
  color: var(--dark-alt);
  margin-top: 4px;
}

body.light-theme .photo-counter {
  color: var(--light-text-light);
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
}

.modal-content {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--light);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-hover);
  z-index: 1001;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

body.light-theme .modal-content {
  background: var(--light-bg-1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  margin: 0;
  color: var(--primary);
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--dark-alt);
}

body.light-theme .close-btn {
  color: var(--light-text-light);
}

.close-btn:hover {
  color: var(--primary);
}

.email-instructions-container {
  position: relative;
}

.copy-btn {
  position: absolute;
  top: 35px;
  right: 10px;
  background: var(--secondary);
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.copy-btn:hover {
  background: var(--secondary-dark);
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  z-index: 2000;
  display: none;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: white;
}

.spinner {
  border: 8px solid #f3f3f3;
  border-top: 8px solid var(--primary);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.locked-input { pointer-events: none; opacity: 0.95; }
</style>
</head>
<body>
<div class="logo-header">
  <span style="font-size: 24px; font-weight: bold; color: var(--omi-text-light);">
    OMI
  </span>
  <div class="theme-selector">
    <button class="theme-btn dark active" onclick="setTheme('dark')">Dark</button>
    <button class="theme-btn light" onclick="setTheme('light')">Light</button>
  </div>
</div>
<div class="container">
<div class="step-indicator">
<div class="step-item active" id="step-indicator-1">
<div class="step-number">1</div>
<div class="step-label">Basic Info</div>
</div>
<div class="step-item" id="step-indicator-2">
<div class="step-number">2</div>
<div class="step-label">Inspection</div>
</div>
<div class="step-item" id="step-indicator-3">
<div class="step-number">3</div>
<div class="step-label">Report</div>
</div>
</div>
<div class="step active" id="step1">
<div class="header">
<h1>OMI PWT UNIT WEEKLY INSPECTION CHECKLIST</h1>
<div class="subtitle">Complete the basic information to begin inspection</div>
</div>
<div class="progress-container">
<div class="progress-bar">
<div class="progress-fill" id="progress-fill"></div>
</div>
<div class="progress-text">
<span id="progress-text">0% Complete</span>
<span>Step 1 of 3</span>
</div>
</div>
<div class="step-container">
<div class="section expanded">
<div class="section-header" onclick="toggleSection(this)">
<div class="section-title">
<i class="fas fa-info-circle"></i>
<span>Basic Information</span>
</div>
<span>▲</span>
</div>
<div class="section-content" style="display: block;">
<div class="form-row">
<div class="form-group hidden">
<label for="equipmentType" class="required">Type of Equipment</label>
<input type="text" id="equipmentType" placeholder="Enter equipment type" required />
<div class="error-message" id="equipmentType-error">Equipment type is required</div>
</div>
<div class="form-group">
<label for="areaLocation" class="required">Area / Location</label>
<input type="text" id="areaLocation" placeholder="Enter location" required />
<div class="error-message" id="areaLocation-error">Area/Location is required</div>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="tagNo" class="required">Tag Number</label>
<input type="text" id="tagNo" placeholder="Enter tag no" required />
<div class="error-message" id="tagNo-error">Tag No is required</div>
</div>
<div class="form-group">
<label for="inspectedBy" class="required">Inspected By</label>
<input type="text" id="inspectedBy" placeholder="Your name" value="Inspector Name" required />
<div class="error-message" id="inspectedBy-error">Inspector name is required</div>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="inspectionDate" class="required">Date of Inspection</label>
<input type="date" id="inspectionDate" required />
<div class="error-message" id="inspectionDate-error">Inspection date is required</div>
</div>
<div class="form-group">
<label for="inspectionTime" class="required">Time of Inspection</label>
<input type="time" id="inspectionTime" required />
<div class="error-message" id="inspectionTime-error">Inspection time is required</div>
</div>
</div>
<div class="form-group">
<label for="emails" class="required">Recipient Emails (comma separated)</label>
<input type="text" id="emails" placeholder="qaqc@omi.om, manager@company.com" value="system@yourcompany.com" required />
<div class="error-message" id="emails-error">At least one valid email is required</div>
<small>At least one email required. Separate multiple emails with commas.</small>
</div>
</div>
</div>
<div class="section expanded">
<div class="section-header" onclick="toggleSection(this)">
<div class="section-title">
<i class="fas fa-cogs"></i>
<span>Equipment Selection</span>
</div>
<span>▲</span>
</div>
<div class="section-content" style="display: block;">
<div class="form-row">
<div class="form-group">
<label for="equipment" class="required">Select Unit</label>
<select id="equipment" required>
<option value="">-- Select --</option>
<option value="DAN-STM">DAN Steam</option>
<option value="PWT-UNIT">PWT Unit</option>
<option value="SS-UNIT">SS Unit</option>
</select>
<div class="error-message" id="equipment-error">Equipment selection is required</div>
</div>
<div class="form-group">
<label for="inspectionFrequency" class="required">Inspection Frequency</label>
<div class="radio-group" id="frequency-dashboard" style="margin-top: 10px;">
  <div class="radio-option" data-value="daily" onclick="selectFrequency(this, 'daily')">Daily</div>
  <div class="radio-option" data-value="weekly" onclick="selectFrequency(this, 'weekly')">Weekly</div>
  <div class="radio-option" data-value="monthly" onclick="selectFrequency(this, 'monthly')">Monthly</div>
</div>
<!-- Original select kept for existing logic; hidden for mobile dashboard UX -->
<select id="inspectionFrequency" required class="hidden">
<option value="">-- Select --</option>
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option value="monthly">Monthly</option>
</select>
<div class="error-message" id="inspectionFrequency-error">Frequency selection is required</div>
</div>
</div>
</div>
</div>
<div class="btn-group">
<button class="btn btn-outline" onclick="showHistory()">
<i class="fas fa-history"></i>
<span>View History</span>
</button>
<button class="btn" id="begin-btn" onclick="validateAndStart()" disabled>
<i class="fas fa-play-circle"></i>
<span>Begin Inspection</span>
</button>
</div>
</div>
</div>
<div class="step" id="step2">
<div class="header">
<h1>OMI PWT UNIT WEEKLY INSPECTION CHECKLIST</h1>
<div class="subtitle">Complete the inspection checklist</div>
</div>
<div class="progress-container">
<div class="progress-bar">
<div class="progress-fill" id="progress-fill-inspect"></div>
</div>
<div class="progress-text">
<span id="progress-text-inspect">0% Complete</span>
<span>Step 2 of 3</span>
</div>
</div>
<div class="step-container">
<div class="info-card">
<i class="fas fa-info-circle"></i>
<strong>Inspection Summary</strong>
<span id="issue-counter" class="issue-counter"></span>
<div id="inspection-summary"></div>
</div>
<div id="checklist-form"></div>
<div class="btn-group">
<button class="btn btn-outline" onclick="goBackToStep1()">
<i class="fas fa-arrow-left"></i>
<span>Back</span>
</button>
<button class="btn btn-secondary" id="submit-report-btn" onclick="submitInspection()" disabled>
<i class="fas fa-check-circle"></i>
<span>Submit Report</span>
</button>
</div>
</div>
</div>
<div class="step" id="step3">
<div class="header">
<h1>OMI PWT UNIT WEEKLY INSPECTION CHECKLIST</h1>
<div class="subtitle">Review and download your inspection report</div>
</div>
<div class="step-container">
<div class="report-section">
<h2>Inspection Report</h2>
<div id="report-output"></div>
<div class="btn-group">
<button class="btn btn-outline" onclick="goBackToStep2()">
<i class="fas fa-edit"></i>
<span>Edit Inspection</span>
</button>
<button class="btn" onclick="downloadPDF()">
<i class="fas fa-file-pdf"></i>
<span>Download PDF</span>
</button>
<button class="btn" onclick="downloadExcel()" style="background-color: var(--secondary);">
<i class="fas fa-file-excel"></i>
<span>Download Excel</span>
</button>
</div>
<div class="btn-group">
<button class="btn btn-secondary" onclick="shareByEmail()">
<i class="fas fa-envelope"></i>
<span>Share via Email</span>
</button>
<button class="btn" onclick="startNewInspection()">
<i class="fas fa-plus-circle"></i>
<span>New Inspection</span>
</button>
</div>
<div class="form-group email-instructions-container" style="margin-top: 24px;">
<label>Email Instructions</label>
<textarea id="email-instructions" rows="4" readonly></textarea>
<button class="copy-btn" onclick="copyEmailInstructions()">
<i class="fas fa-copy"></i>
</button>
<small>Copy this text and send via email, or use the download option above.</small>
</div>
</div>
</div>
</div>
<div id="history-modal" class="hidden">
<div class="modal-overlay" onclick="hideHistory()"></div>
<div class="modal-content">
<div class="modal-header">
<h3>Inspection History</h3>
<button class="close-btn" onclick="hideHistory()">&times;</button>
</div>
<div class="modal-body">
<div id="history-list"></div>
</div>
</div>
</div>
</div>
<div id="loading-overlay" class="loading-overlay">
<div class="spinner"></div>
<p>Generating Report...</p>
</div>
<script>
let checklistData = [];
let currentStep = 1;
// CRITICAL: photos are held in memory, not in localStorage.
// responses are saved, photos are not.
let inspectionState = { responses: {}, photos: {} };
const loadingOverlay = document.getElementById('loading-overlay');

// ============================================
// ACTUAL INSPECTION CHECKLIST DATA
// ============================================
const INSPECTION_CHECKLISTS = {
    "DAN-STM": {
        "daily": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joint", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joint", item: "Aline Key Screws / bolts" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre Condition" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres condition" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "HMI / PLC Status" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Tools & Accessories", item: "Hammer" },
            { category: "Tools & Accessories", item: "Spanner" },
            { category: "Tools & Accessories", item: "Pipe Wrench" },
            { category: "Tools & Accessories", item: "Impact Wrench" },
            { category: "Tools & Accessories", item: "Torque Wrench" }
        ],
        "weekly": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Name plates" },
            { category: "Unit's Body", item: "Spools Insulation" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joint", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joint", item: "Ball Joints / Flexible arms Insulations" },
            { category: "Flanges & Joint", item: "Aline Key Screws / bolts" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre Condition" },
            { category: "Rim / Tyres", item: "Wheel Bolts & Nuts" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Leaf Spring / Shock Absorber" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres condition" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Knobs" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "HMI / PLC" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Jib Crane", item: "Hook & latch" },
            { category: "Tools & Accessories", item: "Hammer" },
            { category: "Tools & Accessories", item: "Spanner" },
            { category: "Tools & Accessories", item: "Pipe Wrench" },
            { category: "Tools & Accessories", item: "Impact Wrench" },
            { category: "Tools & Accessories", item: "Torque Wrench" },
            { category: "Tools & Accessories", item: "Others" }
        ],
        "monthly": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Name plates" },
            { category: "Unit's Body", item: "Spool Insulations" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joint", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joint", item: "Adopter Spools Flange surfaces" },
            { category: "Flanges & Joint", item: "Clamps" },
            { category: "Flanges & Joint", item: "Ball Joints / Flexible arms Insulation" },
            { category: "Flanges & Joint", item: "Snap Rings" },
            { category: "Flanges & Joint", item: "Aline Key Screws / bolts" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre and Rim Condition" },
            { category: "Rim / Tyres", item: "Tyre Expiry Date" },
            { category: "Rim / Tyres", item: "Wheel Bolts & Nuts" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Rear Axles" },
            { category: "Axles & Suspension", item: "Leaf Spring / Shock Absorber" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres condition" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Knobs" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "HMI / PLC" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Cables & Shrouds" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Jib Crane", item: "Hook & latch" },
            { category: "Jib Crane", item: "Jib Crane TPI Next Due Date" },
            { category: "Tools & Accessories", item: "Hammer" },
            { category: "Tools & Accessories", item: "Spanner" },
            { category: "Tools & Accessories", item: "Pipe Wrench" },
            { category: "Tools & Accessories", item: "Impact Wrench" },
            { category: "Tools & Accessories", item: "Torque Wrench" }
        ]
    },
    "PWT-UNIT": {
        "daily": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Sample bottles and Tray" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joints", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joints", item: "Aline Key Screws / bolts" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre Condition" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres & Condition" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jiskoot Sampler", item: "Check Valves (External leakage)" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Compressor System", item: "Noise / Vibration" },
            { category: "Compressor System", item: "Pressure Regulator & Switch" },
            { category: "Compressor System", item: "Compressor Oil level" },
            { category: "Drain Tank", item: "Cover / Cap" },
            { category: "Drain Tank", item: "Leaks" },
            { category: "Drain Tank", item: "Drain Valve Condition" },
            { category: "Tools and Accessories", item: "Hammer" },
            { category: "Tools and Accessories", item: "Spanner" },
            { category: "Tools and Accessories", item: "Pipe Wrench" },
            { category: "Tools and Accessories", item: "Impact Wrench" },
            { category: "Tools and Accessories", item: "Torque Wrench" }
        ],
        "weekly": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Name plates" },
            { category: "Unit's Body", item: "Vessel flushed / drained & free from sediment accumulation" },
            { category: "Unit's Body", item: "Spool Insulations" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joints", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joints", item: "Ball Joints / Flexible arms Insulation" },
            { category: "Flanges & Joints", item: "Aline Key Screws / bolts" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre Condition" },
            { category: "Rim / Tyres", item: "Wheel Bolts & Nuts" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Rear Axles" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres & Condition" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Knobs" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jiskoot Sampler", item: "Check Valves (External leakage)" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Jib Crane", item: "Hook and latch" },
            { category: "Compressor System", item: "Noise / Vibration" },
            { category: "Compressor System", item: "Pressure Regulator & Switch" },
            { category: "Compressor System", item: "Compressor Oil level" },
            { category: "Drain Tank", item: "Cover / Cap" },
            { category: "Drain Tank", item: "Leaks" },
            { category: "Drain Tank", item: "Drain Valve Condition" },
            { category: "Tools and Accessories", item: "Hammer & Spanner" },
            { category: "Tools and Accessories", item: "Pipe Wrench" },
            { category: "Tools and Accessories", item: "Impact Wrench" },
            { category: "Tools and Accessories", item: "Torque Wrench" }
        ],
        "monthly": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Name plates" },
            { category: "Unit's Body", item: "Separator Vessel & piping Insulations" },
            { category: "Unit's Body", item: "Vessel flushed / drained & free from sediment accumulation" },
            { category: "Unit's Body", item: "Spool Insulations" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joints", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joints", item: "Adopter Spools Flange surfaces" },
            { category: "Flanges & Joints", item: "Clamps" },
            { category: "Flanges & Joints", item: "Ball Joints / Flexible arms Insulation" },
            { category: "Flanges & Joints", item: "Snap Rings" },
            { category: "Flanges & Joints", item: "Aline Key Screws / bolts" },
            { category: "Flanges & Joints", item: "Relief Vale Calibration Next Due Date" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre and Rim Condition" },
            { category: "Rim / Tyres", item: "Tyre Expiry Date" },
            { category: "Rim / Tyres", item: "Wheel Bolts & Nuts" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Rear Axles" },
            { category: "Axles & Suspension", item: "Leaf Spring / Shock Absorber" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres & Condition" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Knobs" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Cables & Shrouds" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jiskoot Sampler", item: "Seals" },
            { category: "Jiskoot Sampler", item: "O-Rings" },
            { category: "Jiskoot Sampler", item: "Sample tubes" },
            { category: "Jiskoot Sampler", item: "Capture tubes" },
            { category: "Jiskoot Sampler", item: "Check Valves (Internal / External)" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Jib Crane", item: "Hook and latch" },
            { category: "Jib Crane", item: "Jib Crane TPI Next Due Date" },
            { category: "Compressor System", item: "Noise / Vibration" },
            { category: "Compressor System", item: "Pressure Regulator & Switch" },
            { category: "Compressor System", item: "Compressor Oil level" },
            { category: "Drain Tank", item: "Cover / Cap" },
            { category: "Drain Tank", item: "Leaks" },
            { category: "Drain Tank", item: "Drain Valve Condition" },
            { category: "Tools and Accessories", item: "Hammer & Spanner" },
            { category: "Tools and Accessories", item: "Pipe Wrench" },
            { category: "Tools and Accessories", item: "Impact Wrench" },
            { category: "Tools and Accessories", item: "Torque Wrench" }
        ]
    },
    "SS-UNIT": {
        "daily": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Spool Insulations" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joint", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joint", item: "Ball Joints / Flexible arms Insulation" },
            { category: "Flanges & Joint", item: "Aline Key Screws / bolts" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre Condition" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres available" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "HMI / PLC Status" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Tools & Accessories", item: "Hammer" },
            { category: "Tools & Accessories", item: "Spanner" },
            { category: "Tools & Accessories", item: "Pipe Wrench" },
            { category: "Tools & Accessories", item: "Impact Wrench" },
            { category: "Tools & Accessories", item: "Torque Wrench" }
        ],
        "weekly": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Name plates" },
            { category: "Unit's Body", item: "Spool Insulations" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joint", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joint", item: "Ball Joints / Flexible arms Insulation" },
            { category: "Flanges & Joint", item: "Aline Key Screws / bolts" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre Condition" },
            { category: "Rim / Tyres", item: "Wheel Bolts & Nuts" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Rear Axles" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres available" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Knobs" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "HMI / PLC Status" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Jib Crane", item: "Hook & latch" },
            { category: "Tools & Accessories", item: "Hammer" },
            { category: "Tools & Accessories", item: "Spanner" },
            { category: "Tools & Accessories", item: "Pipe Wrench" },
            { category: "Tools & Accessories", item: "Impact Wrench" },
            { category: "Tools & Accessories", item: "Torque Wrench" },
            { category: "Tools & Accessories", item: "Others" }
        ],
        "monthly": [
            { category: "Unit's Body", item: "Body Paint / dents" },
            { category: "Unit's Body", item: "Reflective Stickers" },
            { category: "Unit's Body", item: "Name plates" },
            { category: "Unit's Body", item: "Separator Vessel & piping Insulations" },
            { category: "Unit's Body", item: "Vessel flushed / drained & free from sediment accumulation" },
            { category: "Unit's Body", item: "Spool Insulations" },
            { category: "Unit's Body", item: "Unit's Cleanliness" },
            { category: "Flanges & Joint", item: "Flange Bolts & Nuts" },
            { category: "Flanges & Joint", item: "Adopter Spools Flange surfaces" },
            { category: "Flanges & Joint", item: "Ball Joints / Flexible arms Insulation" },
            { category: "Flanges & Joint", item: "Clamps" },
            { category: "Flanges & Joint", item: "Snap Rings" },
            { category: "Flanges & Joint", item: "Aline Key Screws / bolts" },
            { category: "Flanges & Joint", item: "Relief Vale Calibration Next Due Date" },
            { category: "Rim / Tyres", item: "Tyre Pressure" },
            { category: "Rim / Tyres", item: "Tyre and Rim Condition" },
            { category: "Rim / Tyres", item: "Tyre Expiry Date" },
            { category: "Rim / Tyres", item: "Wheel Bolts & Nuts" },
            { category: "Rim / Tyres", item: "Tyre Choker" },
            { category: "Axles & Suspension", item: "Rear Axles" },
            { category: "Axles & Suspension", item: "Leaf Spring / Shock Absorber" },
            { category: "Axles & Suspension", item: "Stability Jacks" },
            { category: "Axles & Suspension", item: "Hand brake & Brake fluid Cup" },
            { category: "Emergency Equipments", item: "Assembly Point Board" },
            { category: "Emergency Equipments", item: "Hazard Warning Board" },
            { category: "Emergency Equipments", item: "Reflective cones" },
            { category: "Emergency Equipments", item: "Fire Extinguisher" },
            { category: "Emergency Equipments", item: "Spare tyres available" },
            { category: "Emergency Equipments", item: "Windsock" },
            { category: "Emergency Equipments", item: "Towing Equipment / Hook" },
            { category: "Electrical / Electronics", item: "Battery Status" },
            { category: "Electrical / Electronics", item: "Instruments / Gauges" },
            { category: "Electrical / Electronics", item: "Knobs" },
            { category: "Electrical / Electronics", item: "Solar Panels" },
            { category: "Electrical / Electronics", item: "HMI / PLC" },
            { category: "Electrical / Electronics", item: "Solar Charge controller" },
            { category: "Electrical / Electronics", item: "Cables & Shrouds" },
            { category: "Electrical / Electronics", item: "Earthing Reel, Cable & Clamp condition" },
            { category: "Electrical / Electronics", item: "Unit's Brake Lights" },
            { category: "Jib Crane", item: "Steel Cable" },
            { category: "Jib Crane", item: "Hydraulic jack condition" },
            { category: "Jib Crane", item: "Lifting Belts & Shackle" },
            { category: "Jib Crane", item: "Hook & latch" },
            { category: "Jib Crane", item: "Jib Crane TPI Next Due Date" },
            { category: "Tools & Accessories", item: "Hammer" },
            { category: "Tools & Accessories", item: "Spanner" },
            { category: "Tools & Accessories", item: "Pipe Wrench" },
            { category: "Tools & Accessories", item: "Impact Wrench" },
            { category: "Tools & Accessories", item: "Torque Wrench" }
        ]
    }
};

/* -------------------------------------------------
   Image compression – keeps photos only in memory
   ------------------------------------------------- */
function compressImage(file, quality = 0.8, maxWidth = 1024) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scaleRatio = maxWidth / img.width;
                const newWidth = img.width > maxWidth ? maxWidth : img.width;
                const newHeight = img.width > maxWidth ? img.height * scaleRatio : img.height;
                canvas.width = newWidth;
                canvas.height = newHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, newWidth, newHeight);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
        };
        reader.onerror = reject;
    });
}
async function previewPhoto(itemId) {
    const fileInput = document.getElementById(`${itemId}-photo`);
    const previewContainer = document.getElementById(`${itemId}-preview-container`);
    const preview = document.getElementById(`${itemId}-preview`);
    const counter = document.getElementById(`${itemId}-counter`);
    if (fileInput.files && fileInput.files[0]) {
        loadingOverlay.style.display = 'flex';
        try {
            const compressedImageBase64 = await compressImage(fileInput.files[0]);
            preview.src = compressedImageBase64;
            // Save compressed base64 to IN‑MEMORY state
            inspectionState.photos[itemId] = compressedImageBase64;
            previewContainer.classList.add('show');
            counter.textContent = `1 photo selected`;
            // Persist responses only (photos stay only in memory)
            saveState();
        } catch (error) {
            console.error("Image compression failed:", error);
            alert("Could not process the image. Please try another one.");
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }
}

/* -------------------------------------------------
   Submit – generate report & clear live state
   ------------------------------------------------- */
function submitInspection() {
    if (Object.keys(inspectionState.responses).length < checklistData.length) {
        alert("Please complete all inspection items before submitting.");
        return;
    }
    // Build report & store in history
    generateReportAndSave();

    // -----------------------------------------------------------------
    // Save the *final* basic‑info & state for the PDF/Excel download
    // -----------------------------------------------------------------
    localStorage.setItem('lastBasicInfoForReport', localStorage.getItem('currentInspectionBasicInfo'));
    localStorage.setItem('lastStateForReport', localStorage.getItem('currentInspectionState'));

    // IMPORTANT: clear the active inspection so a fresh start is forced
    localStorage.removeItem('currentInspectionBasicInfo');
    localStorage.removeItem('currentInspectionState');
    goToStep(3);
}
function startNewInspection() {
    // Safest way to reset the app on mobile – just reload the page
    window.location.reload();
}

/* -------------------------------------------------
   Build the report data and render preview (Step 3)
   ------------------------------------------------- */
function generateReportAndSave() {
    const basicInfo = JSON.parse(localStorage.getItem('currentInspectionBasicInfo'));

    const responses = checklistData.map((item, index) => {
        const itemId = `item-${sanitizeForId(item.category)}-${index}`;
        const state = inspectionState.responses[itemId] || {};
        return {
            category: item.category,
            item: item.item,
            response: state.response || 'N/A',
            remarks: state.remarks || '',
            // Photo data comes from the IN‑MEMORY state
            photoUrl: inspectionState.photos[itemId] || ''
        };
    });

    // Render preview on Step 3
    renderReportPreview(basicInfo, responses);

    // Save a *sanitized* version (without photos) to history
    saveToHistory(basicInfo, responses);
}
function renderReportPreview(basicInfo, responses) {
    const reportOutput = document.getElementById('report-output');
    let reportHTML = `
<h3>Equipment: ${basicInfo.equipment}</h3>
<div class="report-item">
<p><strong>Area/Location:</strong> ${basicInfo.areaLocation}</p>
<p><strong>Tag Number:</strong> ${basicInfo.tagNo}</p>
<p><strong>Inspected By:</strong> ${basicInfo.inspectedBy}</p>
<p><strong>Date:</strong> ${basicInfo.inspectionDate}</p>
<p><strong>Time:</strong> ${basicInfo.inspectionTime}</p>
</div>`;

    let currentCategory = '';
    responses.forEach(r => {
        if (r.category !== currentCategory) {
            currentCategory = r.category;
            reportHTML += `<div class="report-category">${r.category}</div>`;
        }
        let statusClass = '';
        if (r.response === 'OK') statusClass = 'status-ok';
        else if (r.response === 'NOT OK') statusClass = 'status-not-ok';
        else if (r.response === 'N/A') statusClass = 'status-na';

        reportHTML += `
<div class="report-item">
<strong>${r.item}:</strong>
<span style="font-weight: bold; color: ${statusClass === 'status-ok' ? 'var(--omi-green)' : statusClass === 'status-not-ok' ? 'var(--omi-red)' : 'var(--omi-text-dark)'};">
${r.response}
</span>
${r.remarks ? `<div class="comment-box"><strong>Remarks:</strong> ${r.remarks}</div>` : ''}
${r.photoUrl ? `<div><img src="${r.photoUrl}" class="photo-preview show" style="max-width: 200px; margin-top: 10px;"></div>` : ''}
</div>`;
    });

    reportOutput.innerHTML = reportHTML;
    document.getElementById('email-instructions').value = `To: ${basicInfo.emails}
Subject: Inspection Report - ${basicInfo.equipment}
Please review the attached PDF for detailed findings.`;
}
function saveToHistory(basicInfo, responses) {
    const history = JSON.parse(localStorage.getItem('inspectionHistory') || '[]');

    // Strip photos – keep history lightweight
    const sanitizedResponses = responses.map(({ photoUrl, ...rest }) => rest);

    const inspectionForHistory = {
        ...basicInfo,
        responses: sanitizedResponses,
        submittedAt: new Date().toISOString()
    };
    history.push(inspectionForHistory);
    try {
        localStorage.setItem('inspectionHistory', JSON.stringify(history));
    } catch (e) {
        console.error("Failed to save history, it might be too large.", e);
        if (history.length > 1) {
            history.shift(); // drop oldest entry
            localStorage.setItem('inspectionHistory', JSON.stringify(history));
        }
    }
}

/* -------------------------------------------------
   Navigation helpers
   ------------------------------------------------- */
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const checklistForm = document.getElementById('checklist-form');
const progressFill = document.getElementById('progress-fill');
const progressText = document.getElementById('progress-text');
const progressFillInspect = document.getElementById('progress-fill-inspect');
const progressTextInspect = document.getElementById('progress-text-inspect');
const beginBtn = document.getElementById('begin-btn');
const submitReportBtn = document.getElementById('submit-report-btn');
const historyModal = document.getElementById('history-modal');
const historyList = document.getElementById('history-list');
const inspectionSummary = document.getElementById('inspection-summary');
const issueCounter = document.getElementById('issue-counter');
function sanitizeForId(text) {
    return text.replace(/[^a-zA-Z0-9]/g, '-');
}
function goToStep(stepNumber) {
    document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
    document.getElementById(`step${stepNumber}`).classList.add('active');
    document.querySelectorAll('.step-item').forEach((item, index) => {
        item.classList.remove('active', 'completed');
        if (index + 1 === stepNumber) item.classList.add('active');
        else if (index + 1 < stepNumber) item.classList.add('completed');
    });
    currentStep = stepNumber;
    window.scrollTo(0, 0);
    if (stepNumber === 2) {
        updateInspectionSummary();
        updateProgress();
    }
}
function goBackToStep1() { goToStep(1); }
function goBackToStep2() { goToStep(2); }
function updateInspectionSummary() {
    const formData = JSON.parse(localStorage.getItem('currentInspectionBasicInfo'));
    if (!formData) return;
    inspectionSummary.innerHTML = `
<div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; font-size: 14px; color: var(--dark-alt);">
<div><strong>Equipment:</strong> ${formData.equipment}</div>
<div><strong>Frequency:</strong> ${formData.inspectionFrequency.charAt(0).toUpperCase() + formData.inspectionFrequency.slice(1)}</div>
<div><strong>Location:</strong> ${formData.areaLocation}</div>
<div><strong>Tag No:</strong> ${formData.tagNo}</div>
<div><strong>Inspector:</strong> ${formData.inspectedBy}</div>
<div><strong>Date:</strong> ${formData.inspectionDate} ${formData.inspectionTime}</div>
</div>`;
}
function validateForm() {
    let isValid = true;
    const requiredFields = ['areaLocation', 'tagNo', 'inspectedBy', 'inspectionDate', 'inspectionTime', 'emails', 'equipment', 'inspectionFrequency'];
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);
        if (!field.value.trim()) {
            errorElement.style.display = 'block';
            field.style.borderColor = 'var(--primary)';
            isValid = false;
        } else {
            errorElement.style.display = 'none';
            field.style.borderColor = '';
        }
    });
    const emailsField = document.getElementById('emails');
    const emailsError = document.getElementById('emails-error');
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const emails = emailsField.value.split(',').map(email => email.trim()).filter(email => email);
    if (emails.length === 0 || !emails.every(email => emailRegex.test(email))) {
        emailsError.style.display = 'block';
        emailsField.style.borderColor = 'var(--primary)';
        isValid = false;
    } else {
        emailsError.style.display = 'none';
        emailsField.style.borderColor = '';
    }
    return isValid;
}
function validateAndStart() {
    // Auto‑capture date/time to prevent manual entry
    setAutoDateTime(true);
    if (!validateForm()) {
        alert("Please fill all required fields correctly.");
        return;
    }
    saveState(); // Save basic info
    renderChecklist();
    goToStep(2);
}
function renderChecklist() {
    checklistForm.innerHTML = '';
    const equipment = document.getElementById('equipment').value;
    const frequency = document.getElementById('inspectionFrequency').value;
    checklistData = INSPECTION_CHECKLISTS[equipment][frequency] || [];

    const categories = checklistData.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = [];
        acc[item.category].push(item);
        return acc;
    }, {});

    let itemIndex = 0;
    Object.keys(categories).forEach(category => {
        const section = document.createElement('div');
        section.className = 'section';
        section.id = `section-${sanitizeForId(category)}`;
        section.innerHTML = `
<div class="section-header" onclick="toggleSection(this)">
<div class="section-title">
<i class="fas fa-list-check"></i>
<span>${category}</span>
</div>
<span class="section-status" id="status-${sanitizeForId(category)}">0/${categories[category].length}</span>
<span>▼</span>
</div>
<div class="section-content">
${categories[category].map(item => renderCategoryItem(item, itemIndex++)).join('')}
</div>
`;
        checklistForm.appendChild(section);
    });

    // Restore any previously saved responses
    Object.keys(inspectionState.responses).forEach(itemId => {
        const { response, remarks } = inspectionState.responses[itemId];
        if (response) {
            const radio = document.querySelector(`input[name="${itemId}"][value="${response}"]`);
            if (radio) radio.click(); // Triggers UI updates
        }
        const remarksText = document.getElementById(`${itemId}-remarks-text`);
        if (remarksText) remarksText.value = remarks;
    });

    // Restore in‑memory photo previews (if we re‑render the same step)
    Object.keys(inspectionState.photos).forEach(itemId => {
        const previewContainer = document.getElementById(`${itemId}-preview-container`);
        const preview = document.getElementById(`${itemId}-preview`);
        const counter = document.getElementById(`${itemId}-counter`);
        if (preview && inspectionState.photos[itemId]) {
            preview.src = inspectionState.photos[itemId];
            previewContainer.classList.add('show');
            counter.textContent = `1 photo selected`;
        }
    });

    updateProgress();
}
function renderCategoryItem(item, index) {
    const itemId = `item-${sanitizeForId(item.category)}-${index}`;
    return `
<div class="checklist-item">
<label>${item.item}</label>
<div class="radio-group">
${['OK', 'NOT OK', 'N/A'].map(opt => {
        const optId = opt.toLowerCase().replace(' ', '-');
        return `
<div class="radio-option" onclick="selectOption(this, '${itemId}', '${opt}')">
<input type="radio" class="radio-input" name="${itemId}" value="${opt}">
${opt}
</div>
`;
    }).join('')}
</div>
<div class="conditional-block" id="${itemId}-conditional">
<div class="form-group" style="padding: 0;">
<label>Remarks</label>
<textarea id="${itemId}-remarks-text" rows="2" placeholder="Enter remarks" oninput="updateRemarks('${itemId}', this.value)"></textarea>
</div>
<div class="photo-upload">
<label>Attach Photo</label>
<input type="file" id="${itemId}-photo" accept="image/*" onchange="previewPhoto('${itemId}')">
<div id="${itemId}-preview-container" class="photo-preview-container">
<img id="${itemId}-preview" class="photo-preview">
<button class="remove-photo-btn" onclick="removePhoto('${itemId}')">&times;</button>
</div>
<div class="photo-counter" id="${itemId}-counter">No photo selected</div>
</div>
</div>
</div>
`;
}
function selectOption(element, itemId, option) {
    document.querySelectorAll(`input[name="${itemId}"]`).forEach(radio => {
        radio.parentElement.classList.remove('selected', 'selected-ok', 'selected-na');
    });
    element.classList.add('selected');
    if (option === 'OK') element.classList.add('selected-ok');
    else if (option === 'N/A') element.classList.add('selected-na');
    element.querySelector('input').checked = true;

    if (!inspectionState.responses[itemId]) inspectionState.responses[itemId] = {};
    inspectionState.responses[itemId].response = option;

    const conditionalBlock = document.getElementById(`${itemId}-conditional`);
    conditionalBlock.classList.toggle('show', option === 'NOT OK');

    updateProgress();
}
function updateRemarks(itemId, value) {
    if (!inspectionState.responses[itemId]) inspectionState.responses[itemId] = {};
    inspectionState.responses[itemId].remarks = value;
    saveState(); // Persist remarks (responses only)
}
function removePhoto(itemId) {
    document.getElementById(`${itemId}-photo`).value = '';
    document.getElementById(`${itemId}-preview-container`).classList.remove('show');
    document.getElementById(`${itemId}-preview`).src = '';
    document.getElementById(`${itemId}-counter`).textContent = 'No photo selected';
    delete inspectionState.photos[itemId];
}
function toggleSection(header) {
    const section = header.parentElement;
    const arrow = header.querySelector('span:last-child');
    const content = header.nextElementSibling;
    section.classList.toggle('expanded');
    if (section.classList.contains('expanded')) {
        content.style.display = 'block';
        arrow.textContent = '▲';
    } else {
        content.style.display = 'none';
        arrow.textContent = '▼';
    }
}
function copyEmailInstructions() {
    const emailInstructions = document.getElementById('email-instructions');
    navigator.clipboard.writeText(emailInstructions.value).then(() => {
        alert('Email instructions copied to clipboard!');
    });
}
function showHistory() {
    const history = JSON.parse(localStorage.getItem('inspectionHistory') || '[]');
    if (history.length === 0) {
        historyList.innerHTML = '<p>No inspection history found.</p>';
    } else {
        historyList.innerHTML = history.reverse().map((item, index) => `
<div class="history-item" onclick="loadHistoryItem(${index})">
<div class="history-header">
<span class="history-date">${item.inspectionDate}</span>
<span class="history-equipment">${item.equipment}</span>
</div>
<div class="history-details">
<p>${item.tagNo} - ${item.areaLocation}</p>
<p>Inspected by: ${item.inspectedBy}</p>
</div>
</div>`).join('');
    }
    historyModal.classList.remove('hidden');
}
function hideHistory() { historyModal.classList.add('hidden'); }
function loadHistoryItem(index) {
    let history = JSON.parse(localStorage.getItem('inspectionHistory') || '[]');
    history = history.reverse(); // Matches reversed display order
    const item = history[index];
    if (item) {
        document.getElementById('areaLocation').value = item.areaLocation || '';
        document.getElementById('tagNo').value = item.tagNo || '';
        document.getElementById('inspectedBy').value = item.inspectedBy || '';
        document.getElementById('inspectionDate').value = item.inspectionDate || '';
        document.getElementById('inspectionTime').value = item.inspectionTime || '';
        document.getElementById('emails').value = item.emails || '';
        document.getElementById('equipment').value = item.equipment || '';
        document.getElementById('inspectionFrequency').value = item.inspectionFrequency || '';
        hideHistory();
        updateProgress();
    }
}

/* ===============================================
   THEME SELECTOR FUNCTIONALITY
   =============================================== */
function setTheme(theme) {
    const body = document.body;
    const darkBtn = document.querySelector('.theme-btn.dark');
    const lightBtn = document.querySelector('.theme-btn.light');
    
    if (theme === 'dark') {
        body.classList.remove('light-theme');
        body.classList.add('dark-theme');
        darkBtn.classList.add('active');
        lightBtn.classList.remove('active');
        localStorage.setItem('theme', 'dark');
    } else {
        body.classList.remove('dark-theme');
        body.classList.add('light-theme');
        lightBtn.classList.add('active');
        darkBtn.classList.remove('active');
        localStorage.setItem('theme', 'light');
    }
    
    // Update progress indicators to reflect theme changes
    updateProgress();
}

/* -------------------------------------------------
   PDF Generation – Updated with new header and footer
   ------------------------------------------------- */
async function downloadPDF() {
    loadingOverlay.style.display = 'flex';
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // -------------------------------------------------
        // 1️⃣ Retrieve basic information
        // -------------------------------------------------
        const basicInfo = JSON.parse(localStorage.getItem('lastBasicInfoForReport'));

        // -------------------------------------------------
        // 2️⃣ Re‑assemble full inspection state (responses + photos)
        // -------------------------------------------------
        const fullInspectionState = {
            responses: JSON.parse(localStorage.getItem('lastStateForReport')).responses,
            photos: inspectionState.photos               // photos live only in memory
        };

        if (!basicInfo || !fullInspectionState) {
            alert("Could not find report data. Please submit an inspection first.");
            return;
        }

        // -------------------------------------------------
        // 3️⃣ Frequency-specific title text
        // -------------------------------------------------
        const frequencyMap = {
            'daily': 'DAILY CHECK LIST',
            'weekly': 'WEEKLY CHECK LIST', 
            'monthly': 'MONTHLY CHECK LIST'
        };
        const freqTitle = frequencyMap[basicInfo.inspectionFrequency] || 'CHECK LIST';

        // -------------------------------------------------
        // 4️⃣ Generate formatted timestamp for footer
        // -------------------------------------------------
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const hours = String(now.getHours() % 12 || 12).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const ampm = now.getHours() >= 12 ? 'pm' : 'am';
        const formattedDate = `${day}/${month}/${year}, ${hours}:${minutes}:${seconds} ${ampm}`;

        // -------------------------------------------------
        // 5️⃣ Header - OMI in bold red + frequency-specific title + equipment
        // -------------------------------------------------
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor('#d32f2f'); // OMI red
        doc.text('OMI', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

        // Reset color for rest of header
        doc.setTextColor('#000000');

        // Frequency-specific title
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text(freqTitle, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

        // Equipment name
        doc.setFontSize(14);
        doc.setFont('helvetica', 'normal');
        doc.text(`Equipment: ${basicInfo.equipment}`, doc.internal.pageSize.getWidth() / 2, 38, { align: 'center' });

        // -------------------------------------------------
        // 6️⃣ Basic‑info table
        // -------------------------------------------------
        const summaryData = [
            ['Area / Location', basicInfo.areaLocation],
            ['Tag Number', basicInfo.tagNo],
            ['Inspected By', basicInfo.inspectedBy],
            ['Date of Inspection', basicInfo.inspectionDate],
            ['Time of Inspection', basicInfo.inspectionTime],
            ['Frequency', freqTitle]
        ];
        doc.autoTable({
            startY: 45,
            body: summaryData,
            theme: 'grid',
            styles: { font: 'helvetica', fontSize: 10 },
            columnStyles: { 0: { fontStyle: 'bold' } }
        });

        // -------------------------------------------------
        // 7️⃣ Checklist table
        // -------------------------------------------------
        const tableHead = ['Category', 'Checklist Item', 'Status', 'Remarks', 'Photo'];
        let photoAppendix = [];
        let photoCounter = 1;

        const tableBody = checklistData.map((r, index) => {
            const itemId = `item-${sanitizeForId(r.category)}-${index}`;
            const responseState = fullInspectionState.responses[itemId] || {};
            let photoRef = 'No';
            if (fullInspectionState.photos[itemId]) {
                photoRef = `Ref: ${photoCounter}`;
                photoAppendix.push({
                    ref: photoCounter,
                    item: r.item,
                    base64: fullInspectionState.photos[itemId]
                });
                photoCounter++;
            }
            return [
                r.category,
                r.item,
                responseState.response || 'N/A',
                responseState.remarks || '-',
                photoRef
            ];
        });

        doc.autoTable({
            startY: doc.autoTable.previous.finalY + 10,
            head: [tableHead],
            body: tableBody,
            theme: 'striped',
            headStyles: { fillColor: [211, 47, 47], textColor: [255, 255, 255] },
            styles: { font: 'helvetica', fontSize: 9, cellPadding: 2 },
            columnStyles: { 3: { cellWidth: 'auto' } },
            didParseCell: (data) => {
                if (data.column.index === 2 && data.cell.section === 'body') {
                    const cellText = String(data.cell.raw).trim();
                    if (cellText === 'NOT OK') {
                        data.cell.styles.fillColor = '#ffcdd2';
                        data.cell.styles.textColor = '#c62828';
                    }
                    if (cellText === 'OK') {
                        data.cell.styles.textColor = '#2e7d32';
                    }
                }
            }
        });

        // -------------------------------------------------
        // 8️⃣ Photo appendix (if any)
        // -------------------------------------------------
        if (photoAppendix.length) {
            doc.addPage();
            doc.setFontSize(16);
            doc.text("Photo Appendix", 14, 22);
            let y = 30;
            const margin = 14;
            const photoWidth = 80;

            for (const photo of photoAppendix) {
                const img = new Image();
                img.src = photo.base64;
                await new Promise(resolve => img.onload = resolve);
                const aspectRatio = img.height / img.width;
                const photoHeight = photoWidth * aspectRatio;

                if (y + photoHeight + 10 > doc.internal.pageSize.height - margin) {
                    doc.addPage();
                    y = 20;
                }

                doc.setFontSize(10);
                doc.text(`Photo ${photo.ref}: ${photo.item}`, margin, y);
                y += 4;
                doc.addImage(photo.base64, 'JPEG', margin, y, photoWidth, photoHeight);
                y += photoHeight + 10;
            }
        }

        // -------------------------------------------------
        // 9️⃣ Footer - Only on Last Page
        // -------------------------------------------------
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor('#555555');
            
            // Page number (all pages)
            doc.text('Page ' + i + ' of ' + pageCount,
                doc.internal.pageSize.getWidth() / 2,
                doc.internal.pageSize.getHeight() - 10,
                { align: 'center' });
            
            // Version/generation info (only on last page)
            if (i === pageCount) {
                const footerText = `Program version 2 | Developed by RMP | Generated: ${formattedDate}`;
                doc.text(footerText, 
                    doc.internal.pageSize.getWidth() / 2, 
                    doc.internal.pageSize.getHeight() - 20, 
                    { align: 'center' });
            }
        }

        // -------------------------------------------------
        // 🔟 Save the file
        // -------------------------------------------------
        const safe = str => str.replace(/[^a-zA-Z0-9]/g, '_');
        const fileName = `OMI_Report_${safe(basicInfo.equipment)}_${safe(basicInfo.tagNo)}_${basicInfo.inspectionFrequency.toUpperCase()}_${basicInfo.inspectionDate}.pdf`;
        doc.save(fileName);
    } finally {
        loadingOverlay.style.display = 'none';
    }
}

/* -------------------------------------------------
   Excel export (unchanged)
   ------------------------------------------------- */
function downloadExcel() {
    const basicInfo = JSON.parse(localStorage.getItem('lastBasicInfoForReport'));
    const fullInspectionState = JSON.parse(localStorage.getItem('lastStateForReport'));
    if (!basicInfo || !fullInspectionState) {
        alert("Could not find report data. Please submit an inspection first.");
        return;
    }
    // --- Define Styles ---
    const thinBorder = {
        top: { style: "thin", color: { rgb: "888888" } },
        bottom: { style: "thin", color: { rgb: "888888" } },
        left: { style: "thin", color: { rgb: "888888" } },
        right: { style: "thin", color: { rgb: "888888" } }
    };
    const summaryHeaderStyle = {
        font: { bold: true },
        fill: { fgColor: { rgb: "F0F0F0" } }, // Light grey
        border: thinBorder
    };
    const summaryValueStyle = {
        border: thinBorder
    };
    const detailsHeaderStyle = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "d32f2f" } }, // OMI Red
        border: thinBorder,
        alignment: { vertical: "center", horizontal: "center" }
    };
    const statusOKStyle = {
        fill: { fgColor: { rgb: "c8e6c9" } }, // Light green
        border: thinBorder
    };
    const statusNotOKStyle = {
        fill: { fgColor: { rgb: "ffcdd2" } }, // Light red
        border: thinBorder
    };
    const statusNAStyle = {
        fill: { fgColor: { rgb: "E0E0E0" } }, // Light grey
        border: thinBorder
    };
    const defaultCellStyle = {
        border: thinBorder
    };
    // --- Create Workbook ---
    const wb = XLSX.utils.book_new();
    // --- Summary Sheet ---
    const summaryData = [
        ["Equipment", basicInfo.equipment],
        ["Inspection Frequency", basicInfo.inspectionFrequency],
        ["Area / Location", basicInfo.areaLocation],
        ["Tag Number", basicInfo.tagNo],
        ["Inspected By", basicInfo.inspectedBy],
        ["Date of Inspection", basicInfo.inspectionDate],
        ["Time of Inspection", basicInfo.inspectionTime],
    ];
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    // Apply styles
    wsSummary['A1'].s = summaryHeaderStyle;
    wsSummary['B1'].s = summaryValueStyle;
    wsSummary['A2'].s = summaryHeaderStyle;
    wsSummary['B2'].s = summaryValueStyle;
    wsSummary['A3'].s = summaryHeaderStyle;
    wsSummary['B3'].s = summaryValueStyle;
    wsSummary['A4'].s = summaryHeaderStyle;
    wsSummary['B4'].s = summaryValueStyle;
    wsSummary['A5'].s = summaryHeaderStyle;
    wsSummary['B5'].s = summaryValueStyle;
    wsSummary['A6'].s = summaryHeaderStyle;
    wsSummary['B6'].s = summaryValueStyle;
    wsSummary['A7'].s = summaryHeaderStyle;
    wsSummary['B7'].s = summaryValueStyle;
    wsSummary['!cols'] = [{ wch: 25 }, { wch: 40 }];
    XLSX.utils.book_append_sheet(wb, wsSummary, "Inspection Summary");
    // --- Details Sheet ---
    let photoCounter = 1;
    const detailsHeaders = ["Category", "Checklist Item", "Status", "Remarks", "Photo"];
    const detailsData = checklistData.map((r, index) => {
        const itemId = `item-${sanitizeForId(r.category)}-${index}`;
        const responseState = fullInspectionState.responses[itemId] || {};
        let photoRef = 'No';
        if (inspectionState.photos[itemId]) {
            photoRef = `See Photo ${photoCounter} in PDF Report`;
            photoCounter++;
        }
        return [
            r.category,
            r.item,
            responseState.response || 'N/A',
            responseState.remarks || '',
            photoRef
        ];
    });
    const wsDetails = XLSX.utils.aoa_to_sheet([detailsHeaders, ...detailsData]);
    // Header styles
    ['A1', 'B1', 'C1', 'D1', 'E1'].forEach(cell => {
        wsDetails[cell].s = detailsHeaderStyle;
    });
    // Data rows
    for (let r = 0; r < detailsData.length; r++) {
        const rowNum = r + 2;
        const status = detailsData[r][2];
        wsDetails[`A${rowNum}`].s = defaultCellStyle;
        wsDetails[`B${rowNum}`].s = defaultCellStyle;
        wsDetails[`D${rowNum}`].s = defaultCellStyle;
        wsDetails[`E${rowNum}`].s = defaultCellStyle;
        if (status === 'OK') wsDetails[`C${rowNum}`].s = statusOKStyle;
        else if (status === 'NOT OK') wsDetails[`C${rowNum}`].s = statusNotOKStyle;
        else wsDetails[`C${rowNum}`].s = statusNAStyle;
    }
    wsDetails['!cols'] = [{ wch: 30 }, { wch: 40 }, { wch: 15 }, { wch: 50 }, { wch: 25 }];
    XLSX.utils.book_append_sheet(wb, wsDetails, "Checklist Details");
    // --- Save File ---
    const safe = str => str.replace(/[^a-zA-Z0-9]/g, '_');
    const fileName = `OMI_Report_${safe(basicInfo.equipment)}_${safe(basicInfo.tagNo)}_${basicInfo.inspectionFrequency.toUpperCase()}_${basicInfo.inspectionDate}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

/* -------------------------------------------------
   Email sharing
   ------------------------------------------------- */
function shareByEmail() {
    const basicInfo = JSON.parse(localStorage.getItem('lastBasicInfoForReport'));
    if (!basicInfo) {
        alert("Could not find report data. Please submit an inspection first.");
        return;
    }
    const recipientEmails = basicInfo.emails || '';
    const subject = `Inspection Report: ${basicInfo.equipment} (${basicInfo.inspectionFrequency}) on ${basicInfo.inspectionDate}`;
    const body = `Dear Team,
Please find the inspection report for ${basicInfo.equipment} (${basicInfo.inspectionFrequency}), conducted by ${basicInfo.inspectedBy} on ${basicInfo.inspectionDate}.
**Please download the PDF report from the web page and attach it to this email before sending.
The PDF contains all details, including photos.**
Summary:
- Equipment: ${basicInfo.equipment}
- Frequency: ${basicInfo.inspectionFrequency}
- Inspected By: ${basicInfo.inspectedBy}
- Date: ${basicInfo.inspectionDate}
Thank you.
`;
    const mailtoLink = `mailto:${recipientEmails}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
}

/* -------------------------------------------------
   Progress & state updates
   ------------------------------------------------- */
function updateProgress() {
    saveState();
    setAutoDateTime(false);
    syncFrequencyDashboard();

    // Step 1 progress
    const requiredFields = ['areaLocation', 'tagNo', 'inspectedBy', 'inspectionDate', 'inspectionTime', 'emails', 'equipment', 'inspectionFrequency'];
    let filledFields = requiredFields.filter(id => document.getElementById(id) && document.getElementById(id).value.trim()).length;
    const step1Percent = Math.round((filledFields / requiredFields.length) * 100);
    progressFill.style.width = `${step1Percent}%`;
    progressText.textContent = `${step1Percent}% Complete`;
    beginBtn.disabled = step1Percent < 100;

    // Step 2 progress (if we are on step 2)
    if (currentStep === 2) {
        const categories = {};
        checklistData.forEach(item => {
            if (!categories[item.category]) categories[item.category] = { total: 0, completed: 0 };
            categories[item.category].total++;
        });
        let completedItems = 0;
        let notOkCount = 0;
        checklistData.forEach((item, index) => {
            const itemId = `item-${sanitizeForId(item.category)}-${index}`;
            const response = inspectionState.responses[itemId]?.response;
            if (response) {
                completedItems++;
                categories[item.category].completed++;
                if (response === 'NOT OK') notOkCount++;
            }
        });
        Object.keys(categories).forEach(category => {
            const catId = sanitizeForId(category);
            const statusElement = document.getElementById(`status-${catId}`);
            const sectionElement = document.getElementById(`section-${catId}`);
            if (statusElement) {
                const { completed, total } = categories[category];
                statusElement.textContent = `${completed}/${total}`;
                if (sectionElement) {
                    sectionElement.classList.toggle('completed', completed === total);
                }
            }
        });
        const totalItems = checklistData.length;
        const step2Percent = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
        progressFillInspect.style.width = `${step2Percent}%`;
        progressTextInspect.textContent = `${step2Percent}% Complete (${completedItems}/${totalItems})`;
        issueCounter.textContent = notOkCount > 0 ? `${notOkCount} issue(s) found` : 'No issues found';
        submitReportBtn.disabled = completedItems < totalItems;
    }
}

/* -------------------------------------------------
   Initialization
   ------------------------------------------------- */
function init() {
    // Load theme preference
    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);
    
    loadState();
    setAutoDateTime(false);
    const inputs = ['areaLocation', 'tagNo', 'inspectedBy', 'inspectionDate', 'inspectionTime', 'emails', 'equipment', 'inspectionFrequency'];
    inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateProgress);
            element.addEventListener('change', updateProgress);
        }
    });
    // If there is no active inspection, start at step 1.
    if (!localStorage.getItem('currentInspectionBasicInfo')) {
        goToStep(1);
    }
    updateProgress();
}

/* ==============================
   Frequency dashboard (Step 1)
   ============================== */
function selectFrequency(element, value) {
    const buttons = document.querySelectorAll('#frequency-dashboard .radio-option');
    buttons.forEach(btn => btn.classList.remove('selected', 'selected-ok', 'selected-na'));
    element.classList.add('selected-ok');

    const sel = document.getElementById('inspectionFrequency');
    if (sel) sel.value = value;

    updateProgress();
}
function syncFrequencyDashboard() {
    const sel = document.getElementById('inspectionFrequency');
    const val = sel ? sel.value : '';
    const buttons = document.querySelectorAll('#frequency-dashboard .radio-option');
    if (!buttons || buttons.length === 0) return;

    buttons.forEach(btn => {
        btn.classList.remove('selected', 'selected-ok', 'selected-na');
        if (val && btn.getAttribute('data-value') === val) {
            btn.classList.add('selected-ok');
        }
    });
}

/* =========================================
   Auto‑capture Date / Time (Step 1)
   ========================================= */
function setAutoDateTime(force = false) {
    const dateEl = document.getElementById('inspectionDate');
    const timeEl = document.getElementById('inspectionTime');
    const now = new Date();

    if (dateEl && (force || !dateEl.value)) {
        dateEl.value = now.toISOString().split('T')[0];
    }
    if (timeEl && (force || !timeEl.value)) {
        timeEl.value = now.toTimeString().substring(0, 5);
    }

    // Lock to avoid manual manipulation on mobile
    if (dateEl) dateEl.classList.add('locked-input');
    if (timeEl) timeEl.classList.add('locked-input');
}

/* Save / Load state (responses only) */
function saveState() {
    const basicInfo = {
        areaLocation: document.getElementById('areaLocation').value,
        tagNo: document.getElementById('tagNo').value,
        inspectedBy: document.getElementById('inspectedBy').value,
        inspectionDate: document.getElementById('inspectionDate').value,
        inspectionTime: document.getElementById('inspectionTime').value,
        emails: document.getElementById('emails').value,
        equipment: document.getElementById('equipment').value,
        inspectionFrequency: document.getElementById('inspectionFrequency').value,
    };
    localStorage.setItem('currentInspectionBasicInfo', JSON.stringify(basicInfo));
    const stateToSave = { responses: inspectionState.responses };
    localStorage.setItem('currentInspectionState', JSON.stringify(stateToSave));
}
function loadState() {
    const basicInfo = JSON.parse(localStorage.getItem('currentInspectionBasicInfo'));
    const savedState = JSON.parse(localStorage.getItem('currentInspectionState'));

    if (basicInfo) {
        document.getElementById('areaLocation').value = basicInfo.areaLocation || '';
        document.getElementById('tagNo').value = basicInfo.tagNo || '';
        document.getElementById('inspectedBy').value = basicInfo.inspectedBy || 'Inspector Name';
        document.getElementById('inspectionDate').value = basicInfo.inspectionDate || new Date().toISOString().split('T')[0];
        document.getElementById('inspectionTime').value = basicInfo.inspectionTime || new Date().toTimeString().substring(0, 5);
        document.getElementById('emails').value = basicInfo.emails || 'system@yourcompany.com';
        document.getElementById('equipment').value = basicInfo.equipment || '';
        document.getElementById('inspectionFrequency').value = basicInfo.inspectionFrequency || '';

        // Keep dashboard in sync with hidden <select>
        syncFrequencyDashboard();
    }

    if (savedState) {
        inspectionState.responses = savedState.responses || {};
    }
    // ALWAYS reset photos – they are never persisted
    inspectionState.photos = {};
}

/* ----------------------------------------------------------------- */
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
