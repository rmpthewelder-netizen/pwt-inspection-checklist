<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>OMI PWT Inspection</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* OMI Dark Theme */
      --omi-red: #d32f2f;
      --omi-red-dark: #b71c1c;
      --omi-dark-1: #1a1a1a; /* Deepest black */
      --omi-dark-2: #2a2a2a; /* Lighter black for cards */
      --omi-dark-3: #37474f; /* Medium gray */
      --omi-text-light: #f5f5f5;
      --omi-text-dark: #b0bec5;
      --omi-green: #2e7d32;
      --omi-green-dark: #1b5e20;
      
      --primary: var(--omi-red);
      --primary-dark: var(--omi-red-dark);
      --secondary: var(--omi-green);
      --secondary-dark: var(--omi-green-dark);
      --light: var(--omi-dark-2);
      --light-alt: var(--omi-dark-1);
      --dark: var(--omi-text-light);
      --dark-alt: var(--omi-text-dark);
      --border: #404040;
      --border-light: #333333;

      --shadow: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-hover: 0 5px 15px rgba(0,0,0,0.4);
      --radius: 8px;
      --radius-sm: 4px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      background: var(--omi-dark-1);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      /* Remove padding for full-width mobile feel */
    }

    .container {
      width: 100%;
      margin: 0 auto;
      background: var(--omi-dark-1);
      /* Remove border-radius and shadow for seamless view */
    }

    .logo-header {
      background: var(--omi-dark-2);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .logo-header img {
      height: 35px;
      object-fit: contain;
    }

    .header {
      background: var(--omi-dark-1);
      color: white;
      padding: 20px 16px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 600;
      color: var(--primary);
    }

    .header .subtitle {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
      color: var(--dark-alt);
    }

    .progress-container {
      padding: 16px;
      background: var(--omi-dark-2);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .progress-bar {
      height: 8px;
      background: var(--border-light);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 4px;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--dark-alt);
    }

    .step-container {
      padding: 16px;
    }

    .step {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .step.active {
      display: block;
    }

    .section {
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin: 16px 0;
      padding: 0; /* Remove padding */
      box-shadow: var(--shadow);
      transition: var(--transition);
      border-left: 4px solid var(--border);
      overflow: hidden; /* For rounded corners */
    }

    .section.completed {
      border-left: 4px solid var(--secondary);
    }

    .section.completed .section-title {
      color: var(--secondary);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .section.expanded .section-header {
      border-bottom: 1px solid var(--border-light);
    }
    
    .section:not(.expanded) .section-header {
        border-bottom: none;
    }

    .section-title {
      font-weight: 600;
      color: var(--primary);
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      font-size: 16px;
    }

    .section-content {
      display: none;
      padding: 16px;
      border-top: 1px solid var(--border-light);
    }

    .section.expanded .section-content {
      display: block;
    }

    .section-status {
      font-size: 14px;
      font-weight: bold;
      color: var(--dark-alt);
      margin-left: auto;
      margin-right: 16px;
    }

    .form-row {
      display: flex;
      flex-direction: column; /* Mobile first */
      gap: 0;
    }

    .form-group {
      flex: 1 1 100%;
      padding: 10px 0; /* Vertical padding */
    }
    
    /* Checklist item specific styling */
    .checklist-item {
        padding: 16px;
        border-bottom: 1px solid var(--border-light);
    }
    .checklist-item:last-child {
        border-bottom: none;
    }

    label {
      display: block;
      margin: 8px 0 6px;
      font-weight: 600;
      font-size: 15px; /* Slightly larger for mobile */
      color: var(--dark);
    }

    .required::after {
      content: " *";
      color: var(--primary);
    }

    input[type="text"], input[type="date"], input[type="time"], select, textarea {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 16px;
      background: var(--omi-dark-3);
      color: var(--dark);
      transition: var(--transition);
    }
    
    input[type="file"] {
        padding: 10px;
        background: var(--omi-dark-3);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 14px;
        width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.2);
    }

    .radio-group {
      display: flex;
      gap: 8px; /* Compact */
      margin: 10px 0;
      flex-wrap: nowrap; /* Force single line */
      justify-content: space-between;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px; /* Smaller padding */
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      background: var(--omi-dark-3);
      color: var(--dark-alt);
      transition: var(--transition);
      flex: 1;
      justify-content: center;
      font-size: 14px; /* Smaller font */
      font-weight: 600;
    }

    .radio-option:hover {
      background: var(--omi-dark-2);
    }

    /* Selected state for 'NOT OK' (default red) */
    .radio-option.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Selected state for 'OK' */
    .radio-option.selected-ok {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }

    /* Selected state for 'N/A' */
    .radio-option.selected-na {
      background: var(--dark-alt);
      color: var(--omi-dark-1);
      border-color: var(--dark-alt);
    }
    
    .radio-input { display: none; }
    .status-indicator { display: none; } /* Hide old indicator */

    /* NEW: Conditional block for Remarks/Photo */
    .conditional-block {
        display: none;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px dashed var(--border);
        animation: fadeIn 0.3s ease;
    }
    .conditional-block.show {
        display: block;
    }

    .photo-upload {
      margin: 16px 0;
    }
    
    .photo-preview-container {
      position: relative;
      margin-top: 8px;
      display: none;
    }

    .photo-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    .remove-photo-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
      line-height: 24px;
      text-align: center;
    }

    .photo-preview-container.show {
      display: block;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 16px 24px; /* Larger tap target */
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: var(--transition);
      display: flex; /* Changed from inline-flex */
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%; /* Mobile first */
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: none; /* No hover effects on mobile */
      box-shadow: none;
    }
    
    .btn:active {
        transform: translateY(1px);
    }

    .btn:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-secondary:hover {
      background: var(--secondary-dark);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    .btn-group {
      display: flex;
      flex-direction: column; /* Mobile first */
      gap: 12px;
      margin: 12px 0;
    }
    
    .btn-group-horizontal .btn {
        flex: 1;
    }

    .hidden {
      display: none !important;
    }

    .report-section {
      background: var(--light);
      padding: 16px;
      border-radius: var(--radius);
      margin: 20px 0;
      box-shadow: var(--shadow);
    }
    
    .report-section h2 {
        color: var(--primary);
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
    }

    .report-item {
      padding: 12px;
      margin: 12px 0;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--omi-dark-3);
    }

    .report-category {
      font-weight: 600;
      color: var(--primary);
      margin: 16px 0 12px;
      padding: 12px;
      background: rgba(211, 47, 47, 0.1);
      border-radius: var(--radius-sm);
      border-left: 4px solid var(--primary);
    }

    .comment-box {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--omi-dark-2);
      color: var(--omi-text-light);
    }
    
    .comment-box strong {
        color: var(--omi-red);
    }

    .info-card {
      background: var(--omi-dark-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin: 16px 0;
    }

    .info-card i {
      color: var(--primary);
      margin-right: 8px;
    }
    
    .info-card .issue-counter {
        color: var(--primary);
        font-weight: bold;
        float: right;
    }

    .error-message {
      color: var(--primary);
      font-size: 14px;
      margin-top: 6px;
      display: none;
    }

    .history-item {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin: 12px 0;
      background: var(--omi-dark-3);
      cursor: pointer;
      transition: var(--transition);
    }

    .history-item:hover {
      box-shadow: var(--shadow);
      border-color: var(--primary);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .history-date {
      font-weight: 600;
      color: var(--primary);
    }

    .history-equipment {
      font-weight: 600;
    }

    .history-details {
      color: var(--dark-alt);
      font-size: 14px;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin: 16px;
      position: relative;
    }

    .step-indicator::before {
      content: '';
      position: absolute;
      top: 19px; /* Center of step number */
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border);
      z-index: 1;
    }

    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      flex: 1; /* Distribute evenly */
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--omi-dark-2);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 8px;
      transition: var(--transition);
      color: var(--dark-alt);
    }

    .step-item.active .step-number {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .step-item.completed .step-number {
      background: var(--secondary);
      border-color: var(--secondary);
      color: white;
    }

    .step-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--dark-alt);
      text-align: center;
    }

    .step-item.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    .step-item.completed .step-label {
      color: var(--secondary);
    }

    .photo-counter {
      font-size: 12px;
      color: var(--dark-alt);
      margin-top: 4px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
    }

    .modal-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--light);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      z-index: 1001;
      width: 90%; /* Mobile first */
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
      margin: 0;
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--dark-alt);
    }

    .close-btn:hover {
      color: var(--primary);
    }
    
    .email-instructions-container {
        position: relative;
    }

    .copy-btn {
        position: absolute;
        top: 35px;
        right: 10px;
        background: var(--secondary);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: var(--radius-sm);
        cursor: pointer;
    }
    .copy-btn:hover {
        background: var(--secondary-dark);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
    }

    .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid var(--primary);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  
  <div class="logo-header">
    <span style="font-size: 24px; font-weight: bold; color: var(--omi-text-light);">
        OMI
    </span>
  </div>

  <div class="container">
    <div class="step-indicator">
      <div class="step-item active" id="step-indicator-1">
        <div class="step-number">1</div>
        <div class="step-label">Basic Info</div>
      </div>
      <div class="step-item" id="step-indicator-2">
        <div class="step-number">2</div>
        <div class="step-label">Inspection</div>
      </div>
      <div class="step-item" id="step-indicator-3">
        <div class="step-number">3</div>
        <div class="step-label">Report</div>
      </div>
    </div>

    <div class="step active" id="step1">
      <div class="header">
        <h1>OMI PWT UNIT WEEKLY INSPECTION CHECKLIST</h1>
        <div class="subtitle">Complete the basic information to begin inspection</div>
      </div>
      
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text">
          <span id="progress-text">0% Complete</span>
          <span>Step 1 of 3</span>
        </div>
      </div>

      <div class="step-container">
        <div class="section expanded">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <i class="fas fa-info-circle"></i>
              <span>Basic Information</span>
            </div>
            <span>▲</span>
          </div>
          <div class="section-content" style="display: block;">
            <div class="form-row">
              <div class="form-group">
                <label for="equipmentType" class="required">Type of Equipment</label>
                <input type="text" id="equipmentType" placeholder="Enter equipment type" required />
                <div class="error-message" id="equipmentType-error">Equipment type is required</div>
              </div>
              <div class="form-group">
                <label for="areaLocation" class="required">Area / Location</label>
                <input type="text" id="areaLocation" placeholder="Enter location" required />
                <div class="error-message" id="areaLocation-error">Area/Location is required</div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="tagNo" class="required">Tag No / Description</label>
                <input type="text" id="tagNo" placeholder="Enter tag no" required />
                <div class="error-message" id="tagNo-error">Tag No is required</div>
              </div>
              <div class="form-group">
                <label for="inspectedBy" class="required">Inspected By</label>
                <input type="text" id="inspectedBy" placeholder="Your name" value="Inspector Name" required />
                <div class="error-message" id="inspectedBy-error">Inspector name is required</div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="inspectionDate" class="required">Date of Inspection</label>
                <input type="date" id="inspectionDate" required />
                <div class="error-message" id="inspectionDate-error">Inspection date is required</div>
              </div>
              <div class="form-group">
                <label for="inspectionTime" class="required">Time of Inspection</label>
                <input type="time" id="inspectionTime" required />
                <div class="error-message" id="inspectionTime-error">Inspection time is required</div>
              </div>
            </div>
             <div class="form-group">
                <label for="emails" class="required">Recipient Emails (comma separated)</label>
                <input type="text" id="emails" placeholder="qaqc@omi.om, manager@company.com" value="system@yourcompany.com" required />
                <div class="error-message" id="emails-error">At least one valid email is required</div>
                <small>At least one email required. Separate multiple emails with commas.</small>
            </div>
          </div>
        </div>

        <div class="section expanded">
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <i class="fas fa-cogs"></i>
              <span>Equipment Selection</span>
            </div>
            <span>▲</span>
          </div>
          <div class="section-content" style="display: block;">
            <div class="form-group">
              <label for="equipment" class="required">Select Equipment</label>
              <select id="equipment" required>
                <option value="">-- Select --</option>
                <option value="PWT-001">PWT-001</option>
                <option value="PWT-002">PWT-002</option>
                <option value="PWT-003">PWT-003</option>
                <option value="PWT-004">PWT-004</option>
                <option value="PWT-005">PWT-005</option>
                <option value="DAN-001">DAN-001</option>
                <option value="OLD-001">OLD-001</option>
                <option value="SSU-001">SSU-001</option>
              </select>
              <div class="error-message" id="equipment-error">Equipment selection is required</div>
            </div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-outline" onclick="showHistory()">
            <i class="fas fa-history"></i>
            <span>View History</span>
          </button>
          <button class="btn" id="begin-btn" onclick="validateAndStart()" disabled>
            <i class="fas fa-play-circle"></i>
            <span>Begin Inspection</span>
          </button>
        </div>
      </div>
    </div>

    <div class="step" id="step2">
      <div class="header">
        <h1>OMI PWT UNIT WEEKLY INSPECTION CHECKLIST</h1>
        <div class="subtitle">Complete the inspection checklist</div>
      </div>
      
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill-inspect"></div>
        </div>
        <div class="progress-text">
          <span id="progress-text-inspect">0% Complete</span>
          <span>Step 2 of 3</span>
        </div>
      </div>

      <div class="step-container">
        <div class="info-card">
          <i class="fas fa-info-circle"></i>
          <strong>Inspection Summary</strong>
          <span id="issue-counter" class="issue-counter"></span>
          <div id="inspection-summary"></div>
        </div>

        <div id="checklist-form"></div>

        <div class="btn-group">
          <button class="btn btn-outline" onclick="goBackToStep1()">
            <i class="fas fa-arrow-left"></i>
            <span>Back</span>
          </button>
          <button class="btn btn-secondary" id="submit-report-btn" onclick="submitInspection()" disabled>
            <i class="fas fa-check-circle"></i>
            <span>Submit Report</span>
          </button>
        </div>
      </div>
    </div>

    <div class="step" id="step3">
      <div class="header">
        <h1>OMI PWT UNIT WEEKLY INSPECTION CHECKLIST</h1>
        <div class="subtitle">Review and download your inspection report</div>
      </div>

      <div class="step-container">
        <div class="report-section">
          <h2>Inspection Report</h2>
          <div id="report-output"></div>
          
          <div class="btn-group">
            <button class="btn btn-outline" onclick="goBackToStep2()">
              <i class="fas fa-edit"></i>
              <span>Edit Inspection</span>
            </button>
            <button class="btn" onclick="downloadPDF()">
              <i class="fas fa-file-pdf"></i>
              <span>Download PDF</span>
            </button>
             <button class="btn" onclick="downloadExcel()" style="background-color: var(--secondary);">
              <i class="fas fa-file-excel"></i>
              <span>Download Excel</span>
            </button>
          </div>
          <div class="btn-group">
             <button class="btn btn-secondary" onclick="shareByEmail()">
                <i class="fas fa-envelope"></i>
                <span>Share via Email</span>
              </button>
            <button class="btn" onclick="startNewInspection()">
              <i class="fas fa-plus-circle"></i>
              <span>New Inspection</span>
            </button>
          </div>
          
          <div class="form-group email-instructions-container" style="margin-top: 24px;">
            <label>Email Instructions</label>
            <textarea id="email-instructions" rows="4" readonly></textarea>
            <button class="copy-btn" onclick="copyEmailInstructions()">
                <i class="fas fa-copy"></i>
            </button>
            <small>Copy this text and send via email, or use the download option above.</small>
          </div>
        </div>
      </div>
    </div>

    <div id="history-modal" class="hidden">
      <div class="modal-overlay" onclick="hideHistory()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Inspection History</h3>
          <button class="close-btn" onclick="hideHistory()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="history-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
      <p>Generating Report...</p>
  </div>

  <script>
    let checklistData = [];
    let currentStep = 1;
    // CRITICAL: photos are held in memory, not in localStorage.
    // responses are saved, photos are not.
    let inspectionState = { responses: {}, photos: {} };
    
    const loadingOverlay = document.getElementById('loading-overlay');
    
    /**
     * Compresses an image file before saving.
     * @param {File} file The image file to compress.
     * @param {number} quality The quality of the output image (0 to 1).
     * @param {number} maxWidth The maximum width of the output image.
     * @returns {Promise<string>} A promise that resolves with the Base64 string of the compressed image.
     */
    function compressImage(file, quality = 0.8, maxWidth = 1024) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scaleRatio = maxWidth / img.width;
                    const newWidth = img.width > maxWidth ? maxWidth : img.width;
                    const newHeight = img.width > maxWidth ? img.height * scaleRatio : img.height;

                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    async function previewPhoto(itemId) {
        const fileInput = document.getElementById(`${itemId}-photo`);
        const previewContainer = document.getElementById(`${itemId}-preview-container`);
        const preview = document.getElementById(`${itemId}-preview`);
        const counter = document.getElementById(`${itemId}-counter`);
        
        if (fileInput.files && fileInput.files[0]) {
            loadingOverlay.style.display = 'flex';
            try {
                // Compress the image
                const compressedImageBase64 = await compressImage(fileInput.files[0]);
                preview.src = compressedImageBase64;
                // Save compressed base64 to IN-MEMORY state
                inspectionState.photos[itemId] = compressedImageBase64; 
                previewContainer.classList.add('show');
                counter.textContent = `1 photo selected`;
                // Save state (which only saves responses, not photos)
                saveState();
            } catch (error) {
                console.error("Image compression failed:", error);
                alert("Could not process the image. Please try another one.");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
    }

    function submitInspection() {
      if (Object.keys(inspectionState.responses).length < checklistData.length) {
        alert("Please complete all inspection items before submitting.");
        return;
      }
      // Generate the report data and save it to history
      generateReportAndSave();
      
      // IMPORTANT: Clear the active inspection state immediately after submission
      // This prevents the app from getting stuck on reload
      localStorage.removeItem('currentInspectionBasicInfo');
      localStorage.removeItem('currentInspectionState');
      
      goToStep(3);
    }

    function startNewInspection() {
        // The most reliable way to reset the app on mobile
        window.location.reload();
    }
    
    function generateReportAndSave() {
        const basicInfo = JSON.parse(localStorage.getItem('currentInspectionBasicInfo'));
        
        // Build the response list for display and history
        const responses = checklistData.map((item, index) => {
            const itemId = `item-${sanitizeForId(item.category)}-${index}`;
            const state = inspectionState.responses[itemId] || {};
            return {
                category: item.category,
                item: item.item,
                response: state.response || 'N/A',
                remarks: state.remarks || '',
                // Photo data is passed from IN-MEMORY state for the report
                photoUrl: inspectionState.photos[itemId] || '' 
            };
        });
        
        // Render the report preview on the screen
        renderReportPreview(basicInfo, responses);
        
        // Save a sanitized version to history (WITHOUT photo data)
        saveToHistory(basicInfo, responses);
    }
    
    function renderReportPreview(basicInfo, responses) {
      const reportOutput = document.getElementById('report-output');
      let reportHTML = `
            <h3>Equipment: ${basicInfo.equipment}</h3>
            <div class="report-item">
              <p><strong>Equipment Type:</strong> ${basicInfo.equipmentType}</p>
              <p><strong>Area/Location:</strong> ${basicInfo.areaLocation}</p>
              <p><strong>Tag No / Description:</strong> ${basicInfo.tagNo}</p>
              <p><strong>Inspected By:</strong> ${basicInfo.inspectedBy}</p>
              <p><strong>Date:</strong> ${basicInfo.inspectionDate}</p>
              <p><strong>Time:</strong> ${basicInfo.inspectionTime}</p>
            </div>`;
            
      let currentCategory = '';
      responses.forEach(r => {
        if (r.category !== currentCategory) {
          currentCategory = r.category;
          reportHTML += `<div class="report-category">${r.category}</div>`;
        }
        
        let statusClass = '';
        if (r.response === 'OK') statusClass = 'status-ok';
        else if (r.response === 'NOT OK') statusClass = 'status-not-ok';
        else if (r.response === 'N/A') statusClass = 'status-na';

        reportHTML += `
          <div class="report-item">
            <strong>${r.item}:</strong> 
            <span style="font-weight: bold; color: ${statusClass === 'status-ok' ? 'var(--omi-green)' : statusClass === 'status-not-ok' ? 'var(--omi-red)' : 'var(--omi-text-dark)'};">
                ${r.response}
            </span>
            ${r.remarks ? `<div class="comment-box"><strong>Remarks:</strong> ${r.remarks}</div>` : ''}
            ${r.photoUrl ? `<div><img src="${r.photoUrl}" class="photo-preview show" style="max-width: 200px; margin-top: 10px;"></div>` : ''}
          </div>`;
      });
      reportOutput.innerHTML = reportHTML;
      
      document.getElementById('email-instructions').value = `To: ${basicInfo.emails}\nSubject: Inspection Report - ${basicInfo.equipment}\n\nPlease review the attached PDF for detailed findings.`;
    }

    function saveToHistory(basicInfo, responses) {
      const history = JSON.parse(localStorage.getItem('inspectionHistory') || '[]');
      
      // Create a version of the inspection for history that does NOT include photo data
      const sanitizedResponses = responses.map(({ photoUrl, ...rest }) => rest);
      
      const inspectionForHistory = {
          ...basicInfo,
          responses: sanitizedResponses,
          submittedAt: new Date().toISOString()
      };
      
      history.push(inspectionForHistory);
      
      try {
        localStorage.setItem('inspectionHistory', JSON.stringify(history));
      } catch (e) {
        console.error("Failed to save history, it might be too large.", e);
        // If history is too large, remove the oldest entry and try again
        if (history.length > 1) {
            history.shift(); // Remove the oldest
            localStorage.setItem('inspectionHistory', JSON.stringify(history));
        }
      }
    }

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const checklistForm = document.getElementById('checklist-form');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const progressFillInspect = document.getElementById('progress-fill-inspect');
    const progressTextInspect = document.getElementById('progress-text-inspect');
    const beginBtn = document.getElementById('begin-btn');
    const submitReportBtn = document.getElementById('submit-report-btn');
    const historyModal = document.getElementById('history-modal');
    const historyList = document.getElementById('history-list');
    const inspectionSummary = document.getElementById('inspection-summary');
    const issueCounter = document.getElementById('issue-counter');
    
    // Sanitize strings for use as IDs
    function sanitizeForId(text) {
        return text.replace(/[^a-zA-Z0-9]/g, '-');
    }
    
    // Save current state to localStorage
    function saveState() {
        const basicInfo = {
            equipmentType: document.getElementById('equipmentType').value,
            areaLocation: document.getElementById('areaLocation').value,
            tagNo: document.getElementById('tagNo').value,
            inspectedBy: document.getElementById('inspectedBy').value,
            inspectionDate: document.getElementById('inspectionDate').value,
            inspectionTime: document.getElementById('inspectionTime').value,
            emails: document.getElementById('emails').value,
            equipment: document.getElementById('equipment').value,
        };
        localStorage.setItem('currentInspectionBasicInfo', JSON.stringify(basicInfo));
        
        // CRITICAL CHANGE: Only save RESPONSES to localStorage, not photos.
        const stateToSave = { responses: inspectionState.responses };
        localStorage.setItem('currentInspectionState', JSON.stringify(stateToSave));
    }

    // Load state from localStorage
    function loadState() {
        const basicInfo = JSON.parse(localStorage.getItem('currentInspectionBasicInfo'));
        
        // CRITICAL CHANGE: Only load RESPONSES. Photos are always reset.
        const savedState = JSON.parse(localStorage.getItem('currentInspectionState'));

        if (basicInfo) {
            document.getElementById('equipmentType').value = basicInfo.equipmentType || '';
            document.getElementById('areaLocation').value = basicInfo.areaLocation || '';
            document.getElementById('tagNo').value = basicInfo.tagNo || '';
            document.getElementById('inspectedBy').value = basicInfo.inspectedBy || 'Inspector Name';
            document.getElementById('inspectionDate').value = basicInfo.inspectionDate || new Date().toISOString().split('T')[0];
            document.getElementById('inspectionTime').value = basicInfo.inspectionTime || new Date().toTimeString().substring(0, 5);
            document.getElementById('emails').value = basicInfo.emails || 'system@yourcompany.com';
            document.getElementById('equipment').value = basicInfo.equipment || '';
        }
        
        // CRITICAL CHANGE
        if (savedState) {
            inspectionState.responses = savedState.responses || {};
        }
        // Always reset photos on load, as they are not persisted.
        inspectionState.photos = {};
    }


    // Initialize checklist from your Excel data
    function initializeChecklist() {
      checklistData = [
        { category: "Unit's Body", item: "Wind sock", options: ["OK", "NOT OK", "N/A"] },
        { category: "Unit's Body", item: "Body Paint / Dents", options: ["OK", "NOT OK", "N/A"] },
        { category: "Unit's Body", item: "Towing Equipment / Hook", options: ["OK", "NOT OK", "N/A"] },
        { category: "Unit's Body", item: "Reflective Stickers", options: ["OK", "NOT OK", "N/A"] },
        { category: "Unit's Body", item: "Name Plates", options: ["OK", "NOT OK", "N/A"] },
        { category: "Unit's Body", item: "Separator Vessel & Piping Insulations", options: ["OK", "NOT OK", "N/A"] },
        { category: "Unit's Body", item: "Spool Insulations", options: ["OK", "NOT OK", "N/A"] },
        { category: "Unit's Body", item: "Unit's Cleanliness", options: ["OK", "NOT OK", "N/A"] },
        { category: "Electrical / Electronics System", item: "Battery Status", options: ["OK", "NOT OK", "N/A"] },
        { category: "Electrical / Electronics System", item: "Instruments / Gauges & PSV", options: ["OK", "NOT OK", "N/A"] },
        { category: "Electrical / Electronics System", item: "Knobs", options: ["OK", "NOT OK", "N/A"] },
        { category: "Electrical / Electronics System", item: "Solar Panels", options: ["OK", "NOT OK", "N/A"] },
        { category: "Electrical / Electronics System", item: "HMI / PLC", options: ["OK", "NOT OK", "N/A"] },
        { category: "Electrical / Electronics System", item: "Solar Charge Controller", options: ["OK", "NOT OK", "N/A"] },
        { category: "Electrical / Electronics System", item: "Cables and Shrouds", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Flange Bolts and Nuts", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Flange Surfaces", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Clamps", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Ball Joints / Flexible Arms", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Adopter Spools / Hoses", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Graphite Packing Gasket", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Snap Rings", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Aline Key Screws / Bolts", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Relief Valve Calibration", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "PRV Chock Been", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Orifice Plate Condition", options: ["OK", "NOT OK", "N/A"] },
        { category: "Flanges and Joint", item: "Straightening Vanes", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jiskoot Sampler", item: "Seals", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jiskoot Sampler", item: "O-Rings", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jiskoot Sampler", item: "Sample Tools", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jiskoot Sampler", item: "Capture Tools", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jiskoot Sampler", item: "Check Valves (Internal / External)", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jib Crane", item: "Rope Condition", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jib Crane", item: "Hydraulic Jack Condition", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jib Crane", item: "Lifting Belts and Shackle", options: ["OK", "NOT OK", "N/A"] },
        { category: "Jib Crane", item: "Hook and Latch", options: ["OK", "NOT OK", "N/A"] },
        { category: "Rim / Tyres", item: "Tyre Pressure", options: ["OK", "NOT OK", "N/A"] },
        { category: "Rim / Tyres", item: "Tyre and Rim Condition", options: ["OK", "NOT OK", "N/A"] },
        { category: "Axles and Suspension", item: "Front / Rear Axles", options: ["OK", "NOT OK", "N/A"] },
        { category: "Axles and Suspension", item: "Leaf Spring / Shock Absorber", options: ["OK", "NOT OK", "N/A"] },
        { category: "Axles and Suspension", item: "Stability Jacks", options: ["OK", "NOT OK", "N/A"] },
        { category: "Axles and Suspension", item: "Hand Brake & Brake Fluid Cup", options: ["OK", "NOT OK", "N/A"] },
        { category: "Emergency Equipment", item: "Assembly Point Board", options: ["OK", "NOT OK", "N/A"] },
        { category: "Emergency Equipment", item: "Hazard Warning Board", options: ["OK", "NOT OK", "N/A"] },
        { category: "Emergency Equipment", item: "Reflective Cones", options: ["OK", "NOT OK", "N/A"] },
        { category: "Emergency Equipment", item: "Fire Extinguisher", options: ["OK", "NOT OK", "N/A"] },
        { category: "Emergency Equipment", item: "Spare Tyres Available", options: ["OK", "NOT OK", "N/A"] },
        { category: "Tools and Accessories", item: "Hammer", options: ["OK", "NOT OK", "N/A"] },
        { category: "Tools and Accessories", item: "Spanner", options: ["OK", "NOT OK", "N/A"] },
        { category: "Tools and Accessories", item: "Pipe Wrench", options: ["OK", "NOT OK", "N/A"] },
        { category: "Tools and Accessories", item: "Tighter Machine", options: ["OK", "NOT OK", "N/A"] },
        { category: "Compressor System", item: "Noise / Vibration", options: ["OK", "NOT OK", "N/A"] },
        { category: "Compressor System", item: "Pressure Regulator and Switch", options: ["OK", "NOT OK", "N/A"] },
        { category: "Drain Tank", item: "Cover / Cap", options: ["OK", "NOT OK", "N/A"] },
        { category: "Drain Tank", item: "Leaks", options: ["OK", "NOT OK", "N/A"] },
        { category: "Drain Tank", item: "Drain Valve Condition", options: ["OK", "NOT OK", "N/A"] },
        { category: "Drain Tank", item: "Drain Hose", options: ["OK", "NOT OK", "N/A"] }
      ]; // Total 57 items
    }

    // Navigation functions
    function goToStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.getElementById(`step${stepNumber}`).classList.add('active');
      
      document.querySelectorAll('.step-item').forEach((item, index) => {
        item.classList.remove('active', 'completed');
        if (index + 1 === stepNumber) item.classList.add('active');
        else if (index + 1 < stepNumber) item.classList.add('completed');
      });
      
      currentStep = stepNumber;
      window.scrollTo(0, 0); // Scroll to top on step change
      
      if (stepNumber === 2) {
        updateInspectionSummary();
        updateProgress();
      }
    }

    function goBackToStep1() { goToStep(1); }
    function goBackToStep2() { goToStep(2); }

    function updateInspectionSummary() {
      const formData = JSON.parse(localStorage.getItem('currentInspectionBasicInfo'));
      if (!formData) return;
      
      inspectionSummary.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; font-size: 14px; color: var(--dark-alt);">
          <div><strong>Equipment:</strong> ${formData.equipment}</div>
          <div><strong>Type:</strong> ${formData.equipmentType}</div>
          <div><strong>Location:</strong> ${formData.areaLocation}</div>
          <div><strong>Tag No:</strong> ${formData.tagNo}</div>
          <div><strong>Inspector:</strong> ${formData.inspectedBy}</div>
          <div><strong>Date:</strong> ${formData.inspectionDate} ${formData.inspectionTime}</div>
        </div>`;
    }

    function validateForm() {
      let isValid = true;
      const requiredFields = ['equipmentType', 'areaLocation', 'tagNo', 'inspectedBy', 'inspectionDate', 'inspectionTime', 'emails', 'equipment'];
      
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);
        if (!field.value.trim()) {
          errorElement.style.display = 'block';
          field.style.borderColor = 'var(--primary)';
          isValid = false;
        } else {
          errorElement.style.display = 'none';
          field.style.borderColor = '';
        }
      });
      
      const emailsField = document.getElementById('emails');
      const emailsError = document.getElementById('emails-error');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const emails = emailsField.value.split(',').map(email => email.trim()).filter(email => email);
      
      if (emails.length === 0 || !emails.every(email => emailRegex.test(email))) {
        emailsError.style.display = 'block';
        emailsField.style.borderColor = 'var(--primary)';
        isValid = false;
      } else {
        emailsError.style.display = 'none';
        emailsField.style.borderColor = '';
      }
      return isValid;
    }

    function validateAndStart() {
      if (!validateForm()) {
        alert("Please fill all required fields correctly.");
        return;
      }
      saveState(); // Save basic info
      renderChecklist();
      goToStep(2);
    }

    function renderChecklist() {
      checklistForm.innerHTML = '';
      const categories = checklistData.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = [];
        acc[item.category].push(item);
        return acc;
      }, {});
      
      let itemIndex = 0;
      Object.keys(categories).forEach(category => {
        const section = document.createElement('div');
        section.className = 'section'; // Start collapsed
        section.id = `section-${sanitizeForId(category)}`;
        
        section.innerHTML = `
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <i class="fas fa-list-check"></i>
              <span>${category}</span>
            </div>
            <span class="section-status" id="status-${sanitizeForId(category)}">0/${categories[category].length}</span>
            <span>▼</span>
          </div>
          <div class="section-content">
            ${categories[category].map(item => renderCategoryItem(item, itemIndex++)).join('')}
          </div>
        `;
        checklistForm.appendChild(section);
      });
      
      // Restore state to rendered form
      Object.keys(inspectionState.responses).forEach(itemId => {
        const { response, remarks } = inspectionState.responses[itemId];
        if (response) {
            const radio = document.querySelector(`input[name="${itemId}"][value="${response}"]`);
            if (radio) radio.click(); // This will trigger selectOption
        }
        const remarksText = document.getElementById(`${itemId}-remarks-text`);
        if (remarksText) remarksText.value = remarks;
      });
      
      // Re-apply photo previews from in-memory state (e.g., if re-rendering)
      Object.keys(inspectionState.photos).forEach(itemId => {
          const previewContainer = document.getElementById(`${itemId}-preview-container`);
          const preview = document.getElementById(`${itemId}-preview`);
          const counter = document.getElementById(`${itemId}-counter`);
          if (preview && inspectionState.photos[itemId]) {
              preview.src = inspectionState.photos[itemId];
              previewContainer.classList.add('show');
              counter.textContent = `1 photo selected`;
          }
      });
      
      updateProgress();
    }

    function renderCategoryItem(item, index) {
      const itemId = `item-${sanitizeForId(item.category)}-${index}`;
      return `
        <div class="checklist-item">
          <label>${item.item}</label>
          <div class="radio-group">
            ${item.options.map(opt => {
              const optId = opt.toLowerCase().replace(' ', '-');
              return `
              <div class="radio-option" onclick="selectOption(this, '${itemId}', '${opt}')">
                <input type="radio" class="radio-input" name="${itemId}" value="${opt}">
                ${opt}
              </div>
            `}).join('')}
          </div>
          
          <div class="conditional-block" id="${itemId}-conditional">
            <div class="form-group" style="padding: 0;">
              <label>Remarks</label>
              <textarea id="${itemId}-remarks-text" rows="2" placeholder="Enter remarks" oninput="updateRemarks('${itemId}', this.value)"></textarea>
            </div>
            <div class="photo-upload">
              <label>Attach Photo</label>
              <input type="file" id="${itemId}-photo" accept="image/*" onchange="previewPhoto('${itemId}')">
              <div id="${itemId}-preview-container" class="photo-preview-container">
                  <img id="${itemId}-preview" class="photo-preview">
                  <button class="remove-photo-btn" onclick="removePhoto('${itemId}')">&times;</button>
              </div>
              <div class="photo-counter" id="${itemId}-counter">No photo selected</div>
            </div>
          </div>
          </div>
      `;
    }

    function selectOption(element, itemId, option) {
        // Handle radio button selection styling
        document.querySelectorAll(`input[name="${itemId}"]`).forEach(radio => {
            radio.parentElement.classList.remove('selected', 'selected-ok', 'selected-na');
        });
        
        element.classList.add('selected'); // Default 'NOT OK' style
        if (option === 'OK') {
            element.classList.add('selected-ok');
        } else if (option === 'N/A') {
            element.classList.add('selected-na');
        }
        element.querySelector('input').checked = true;

        // Save the response
        if (!inspectionState.responses[itemId]) inspectionState.responses[itemId] = {};
        inspectionState.responses[itemId].response = option;

        // CRITICAL: Show/hide the conditional block
        const conditionalBlock = document.getElementById(`${itemId}-conditional`);
        conditionalBlock.classList.toggle('show', option === 'NOT OK');

        updateProgress();
    }
    
    function updateRemarks(itemId, value) {
        if (!inspectionState.responses[itemId]) inspectionState.responses[itemId] = {};
        inspectionState.responses[itemId].remarks = value;
        saveState(); // Save text changes
    }
    
    function removePhoto(itemId) {
        document.getElementById(`${itemId}-photo`).value = '';
        document.getElementById(`${itemId}-preview-container`).classList.remove('show');
        document.getElementById(`${itemId}-preview`).src = '';
        document.getElementById(`${itemId}-counter`).textContent = 'No photo selected';
        // Remove from in-memory state
        delete inspectionState.photos[itemId];
        // Don't need to call saveState() as photos aren't saved
    }

    function toggleSection(header) {
      const section = header.parentElement;
      const arrow = header.querySelector('span:last-child');
      const content = header.nextElementSibling;
      
      section.classList.toggle('expanded');
      
      if (section.classList.contains('expanded')) {
          content.style.display = 'block';
          arrow.textContent = '▲';
      } else {
          content.style.display = 'none';
          arrow.textContent = '▼';
      }
    }
    
    function copyEmailInstructions() {
        const emailInstructions = document.getElementById('email-instructions');
        navigator.clipboard.writeText(emailInstructions.value).then(() => {
            alert('Email instructions copied to clipboard!');
        });
    }

    function showHistory() {
      const history = JSON.parse(localStorage.getItem('inspectionHistory') || '[]');
      if (history.length === 0) {
        historyList.innerHTML = '<p>No inspection history found.</p>';
      } else {
        historyList.innerHTML = history.reverse().map((item, index) => `
          <div class="history-item" onclick="loadHistoryItem(${index})">
            <div class="history-header">
              <span class="history-date">${item.inspectionDate}</span>
              <span class="history-equipment">${item.equipment}</div>
            <div class="history-details">
              <p>${item.equipmentType} - ${item.areaLocation}</p>
              <p>Inspected by: ${item.inspectedBy}</p>
            </div>
          </div>`).join('');
      }
      historyModal.classList.remove('hidden');
    }

    function hideHistory() { historyModal.classList.add('hidden'); }

    function loadHistoryItem(index) {
      let history = JSON.parse(localStorage.getItem('inspectionHistory') || '[]');
      history = history.reverse(); // Match the reversed display order
      const item = history[index];
      if (item) {
        document.getElementById('equipmentType').value = item.equipmentType || '';
        document.getElementById('areaLocation').value = item.areaLocation || '';
        document.getElementById('tagNo').value = item.tagNo || '';
        document.getElementById('inspectedBy').value = item.inspectedBy || '';
        document.getElementById('inspectionDate').value = item.inspectionDate || '';
        document.getElementById('inspectionTime').value = item.inspectionTime || '';
        document.getElementById('emails').value = item.emails || '';
        document.getElementById('equipment').value = item.equipment || '';
        
        hideHistory();
        updateProgress();
      }
    }

    async function downloadPDF() {
        loadingOverlay.style.display = 'flex';
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const basicInfo = JSON.parse(localStorage.getItem('lastBasicInfoForReport'));
            
            // We use the IN-MEMORY state for photos
            const fullInspectionState = {
                responses: JSON.parse(localStorage.getItem('lastStateForReport')).responses,
                photos: inspectionState.photos // Use current in-memory photos
            };

            if (!basicInfo || !fullInspectionState) {
                alert("Could not find report data. Please submit an inspection first.");
                return;
            }
            
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("Weekly Inspection Report", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text(`Equipment: ${basicInfo.equipment}`, doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
            
            const summaryData = [
                ['Equipment Type', basicInfo.equipmentType, 'Inspected By', basicInfo.inspectedBy],
                ['Area / Location', basicInfo.areaLocation, 'Date of Inspection', basicInfo.inspectionDate],
                ['Tag No / Description', basicInfo.tagNo, 'Time of Inspection', basicInfo.inspectionTime]
            ];
            
            doc.autoTable({
                startY: 40, body: summaryData, theme: 'grid',
                styles: { font: 'helvetica', fontSize: 10 },
                columnStyles: { 0: { fontStyle: 'bold' }, 2: { fontStyle: 'bold' } },
            });
            
            const tableHead = ['Category', 'Checklist Item', 'Status', 'Remarks', 'Photo'];
            let photoAppendix = [];
            let photoCounter = 1;
            
            const tableBody = checklistData.map((r, index) => {
                const itemId = `item-${sanitizeForId(r.category)}-${index}`;
                const responseState = fullInspectionState.responses[itemId] || {};
                let photoRef = 'No';
                
                // Check for photo in the IN-MEMORY state
                if (fullInspectionState.photos[itemId]) {
                    photoRef = `Ref: ${photoCounter}`;
                    photoAppendix.push({
                        ref: photoCounter,
                        item: r.item,
                        base64: fullInspectionState.photos[itemId]
                    });
                    photoCounter++;
                }
                return [
                    r.category,
                    r.item,
                    responseState.response || 'N/A',
                    responseState.remarks || '-',
                    photoRef
                ];
            });

            doc.autoTable({
                startY: doc.autoTable.previous.finalY + 10, head: [tableHead], body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [211, 47, 47], textColor: [255, 255, 255] },
                styles: { font: 'helvetica', fontSize: 9, cellPadding: 2 },
                columnStyles: { 3: { cellWidth: 'auto' } },
                didParseCell: (data) => {
                    if (data.column.index === 2 && data.cell.section === 'body') {
                        const cellText = String(data.cell.raw).trim();
                        if(cellText === 'NOT OK') {
                            data.cell.styles.fillColor = '#ffcdd2'; data.cell.styles.textColor = '#c62828';
                        }
                        if(cellText === 'OK') {
                            data.cell.styles.textColor = '#2e7d32';
                        }
                    }
                }
            });

            if (photoAppendix.length > 0) {
                doc.addPage();
                doc.setFontSize(16);
                doc.text("Photo Appendix", 14, 22);
                let y = 30;
                const margin = 14;
                const photoWidth = 80;
                
                for (const photo of photoAppendix) {
                    const img = new Image();
                    img.src = photo.base64;
                    await new Promise(resolve => img.onload = resolve);
                    
                    const aspectRatio = img.height / img.width;
                    const photoHeight = photoWidth * aspectRatio;

                    if (y + photoHeight + 10 > doc.internal.pageSize.height - margin) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setFontSize(10);
                    doc.text(`Photo ${photo.ref}: ${photo.item}`, margin, y);
                    y += 4;
                    doc.addImage(photo.base64, 'JPEG', margin, y, photoWidth, photoHeight);
                    y += photoHeight + 10;
                }
            }
            
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text('Page ' + i + ' of ' + pageCount, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
            }

            const sanitizedInspector = basicInfo.inspectedBy.replace(/[^a-zA-Z0-9]/g, '_');
            const sanitizedEquipment = basicInfo.equipment.replace(/[^a-zA-Z0-9]/g, '_');
            const fileName = `Inspection_Report_${sanitizedEquipment}_${sanitizedInspector}_${basicInfo.inspectionDate}.pdf`;
            
            doc.save(fileName);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }
    
    function downloadExcel() {
        const basicInfo = JSON.parse(localStorage.getItem('lastBasicInfoForReport'));
        const fullInspectionState = JSON.parse(localStorage.getItem('lastStateForReport'));

        if (!basicInfo || !fullInspectionState) {
            alert("Could not find report data. Please submit an inspection first.");
            return;
        }
        
        const wb = XLSX.utils.book_new();
        
        const summaryData = [
            { "Field": "Equipment", "Value": basicInfo.equipment },
            { "Field": "Equipment Type", "Value": basicInfo.equipmentType },
            { "Field": "Area / Location", "Value": basicInfo.areaLocation },
            { "Field": "Tag No / Description", "Value": basicInfo.tagNo },
            { "Field": "Inspected By", "Value": basicInfo.inspectedBy },
            { "Field": "Date of Inspection", "Value": basicInfo.inspectionDate },
            { "Field": "Time of Inspection", "Value": basicInfo.inspectionTime },
        ];
        const wsSummary = XLSX.utils.json_to_sheet(summaryData);
        wsSummary['!cols'] = [{ wch: 25 }, { wch: 40 }];
        XLSX.utils.book_append_sheet(wb, wsSummary, "Inspection Summary");

        let photoCounter = 1;
        const detailsData = checklistData.map((r, index) => {
            const itemId = `item-${sanitizeForId(r.category)}-${index}`;
            const responseState = fullInspectionState.responses[itemId] || {};
            let photoRef = 'No';
            
            // We can't embed photos in Excel, so we just reference them
            // We check the IN-MEMORY state
            if (inspectionState.photos[itemId]) {
                photoRef = `See Photo ${photoCounter} in PDF Report`;
                photoCounter++;
            }
            return {
                "Category": r.category,
                "Checklist Item": r.item,
                "Status": responseState.response || 'N/A',
                "Remarks": responseState.remarks || '',
                "Photo Attached": photoRef
            };
        });
        const wsDetails = XLSX.utils.json_to_sheet(detailsData);
        wsDetails['!cols'] = [{ wch: 30 }, { wch: 40 }, { wch: 15 }, { wch: 50 }, { wch: 25 }];
        XLSX.utils.book_append_sheet(wb, wsDetails, "Checklist Details");

        const sanitizedInspector = basicInfo.inspectedBy.replace(/[^a-zA-Z0-9]/g, '_');
        const sanitizedEquipment = basicInfo.equipment.replace(/[^a-zA-Z0-9]/g, '_');
        const fileName = `Inspection_Report_${sanitizedEquipment}_${sanitizedInspector}_${basicInfo.inspectionDate}.xlsx`;
        
        XLSX.writeFile(wb, fileName);
    }
    
    function shareByEmail() {
        const basicInfo = JSON.parse(localStorage.getItem('lastBasicInfoForReport'));
        if (!basicInfo) {
            alert("Could not find report data. Please submit an inspection first.");
            return;
        }

        const recipientEmails = basicInfo.emails || '';
        const subject = `Inspection Report: ${basicInfo.equipment} on ${basicInfo.inspectionDate}`;
        const body = `Dear Team,

Please find the inspection report for ${basicInfo.equipment}, conducted by ${basicInfo.inspectedBy} on ${basicInfo.inspectionDate}.

**Please download the PDF report from the web page and attach it to this email before sending.
The PDF contains all details, including photos.**

Summary:
- Equipment: ${basicInfo.equipment}
- Inspected By: ${basicInfo.inspectedBy}
- Date: ${basicInfo.inspectionDate}

Thank you.
        `;
        
        const mailtoLink = `mailto:${recipientEmails}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailtoLink;
    }


    function updateProgress() {
      saveState();
      
      // Step 1 Progress
      const requiredFields = ['equipmentType', 'areaLocation', 'tagNo', 'inspectedBy', 'inspectionDate', 'inspectionTime', 'emails', 'equipment'];
      let filledFields = requiredFields.filter(id => document.getElementById(id) && document.getElementById(id).value.trim()).length;
      const step1Percent = Math.round((filledFields / requiredFields.length) * 100);
      progressFill.style.width = `${step1Percent}%`;
      progressText.textContent = `${step1Percent}% Complete`;
      beginBtn.disabled = step1Percent < 100;

      // Step 2 Progress
      if (currentStep === 2) {
        const categories = {};
        checklistData.forEach(item => {
            if (!categories[item.category]) categories[item.category] = { total: 0, completed: 0 };
            categories[item.category].total++;
        });
        
        let completedItems = 0;
        let notOkCount = 0;
        
        checklistData.forEach((item, index) => {
            const itemId = `item-${sanitizeForId(item.category)}-${index}`;
            const response = inspectionState.responses[itemId]?.response;
            if (response) {
                completedItems++;
                categories[item.category].completed++;
                if (response === 'NOT OK') notOkCount++;
            }
        });
        
        Object.keys(categories).forEach(category => {
          const catId = sanitizeForId(category);
          const statusElement = document.getElementById(`status-${catId}`);
          const sectionElement = document.getElementById(`section-${catId}`);
          if (statusElement) {
            const { completed, total } = categories[category];
            statusElement.textContent = `${completed}/${total}`;
            if (sectionElement) {
                sectionElement.classList.toggle('completed', completed === total);
            }
          }
        });
        
        const totalItems = checklistData.length;
        const step2Percent = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
        progressFillInspect.style.width = `${step2Percent}%`;
        progressTextInspect.textContent = `${step2Percent}% Complete (${completedItems}/${totalItems})`;
        
        issueCounter.textContent = notOkCount > 0 ?
          `${notOkCount} issue(s) found` : 'No issues found';
        
        submitReportBtn.disabled = completedItems < totalItems;
      }
    }

    function init() {
      initializeChecklist();
      
      // On initial load, check for an active inspection.
      loadState();
      
      // Temporarily store the completed inspection data for the report page
      // This is safe because it's just text data
      if (localStorage.getItem('currentInspectionBasicInfo')) {
          localStorage.setItem('lastBasicInfoForReport', localStorage.getItem('currentInspectionBasicInfo'));
      }
      if (localStorage.getItem('currentInspectionState')) {
          localStorage.setItem('lastStateForReport', localStorage.getItem('currentInspectionState'));
      }

      const inputs = ['equipmentType', 'areaLocation', 'tagNo', 'inspectedBy', 'inspectionDate', 'inspectionTime', 'emails', 'equipment'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateProgress);
          element.addEventListener('change', updateProgress);
        }
      });

      // If there is no active inspection, start at step 1.
      if (!localStorage.getItem('currentInspectionBasicInfo')) {
          goToStep(1);
      }
      
      updateProgress();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
